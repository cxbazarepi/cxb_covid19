---
title: 'COVID-19  Dashboard: Coxâ€™s Bazar, Bangladesh'
subtitle: 'This is the subtitle'
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: ''
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: bootstrap
    #logo: who_logo.png
#runtime: shiny
resource_files:
- data/camp_population.csv
- data/shapefiles/190321_Outline_RRC_Camp-A1.prj
- data/shapefiles/190321_Outline_RRC_Camp-A1.sbx
- data/shapefiles/190321_Outline_RRC_Camp-A1.sbn
- data/shapefiles/190321_Outline_RRC_Camp-A1.dbf
- data/shapefiles/190321_Outline_RRC_Camp-A1.cpg
- data/shapefiles/190321_Outline_RRC_Camp-A1.shp
- data/droptoken.rds

---
```{r global, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, error=TRUE)


library(lubridate)
library(here)
library(data.table)
library(dplyr)
#library(tibble)
#library(purrr)
library(janitor)
library(linelist)
library(forcats)
library(ggplot2)
library(ggthemes)
library(gt)
library(tidyr)
library(RcppRoll)
library(scales)
library(sf)
library(leaflet)
#library(patchwork)
library(flexdashboard)
#library(linelist)
#library(googlesheets4)
#library(kableExtra)
library(plotly)
#library(httr)
#library(jsonlite)
#library(magrittr)
library(ggupset)
#library(furrr)
library(table1)
#library(deidentifyr)
library(rdrop2)
library(ggpubr)
library(tmap)
library(htmltools)
library(purrr)
library(googlesheets4)
library(here)
library(tibble)
library(tidyr)
library(httr)
library(jsonlite)
library(magrittr)
#library(tibble, lib.loc = "/usr/local/lib/R/site-library")
library(tibble)
library(stringr)



age_labs <- c(paste(seq(0, 60, by = 10), seq(9, 69, by = 10),
                    sep = "-"), paste(70, "+", sep = ""))

options(scipen=10000)


sheet_names <- c('fdmn', 'host', 'ari_ili', 'testing', 'dru', 'quarantine')
#sheet_names <- c('host_fdmn_append',  'testing')
#sheet_names <- c('host_fdmn_append',  'testing', 'dru', 'quarantine')

gdrive_link <- "1Gnutu0OxxFJJq73KUzLQzHZHteFwpQP-B_tXct7OGwE"

#plan(multiprocess)


#gs4_deauth()
gsheet_data <- map(sheet_names, ~read_sheet(gdrive_link, sheet=.)) %>%  set_names(sheet_names)

# #Google data
#  token <- readRDS("data/droptoken.rds")
# # # Then pass the token to each drop_ function
# # 
# # #My example
# drop_download(path = '/cxb/gsheet_data.Rds',
#               local_path = 'gsheet_data.Rds',
#               dtoken = token,
#               overwrite = TRUE)
# 
# # Main data frame for data analysis
# gsheet_data <- readRDS('gsheet_data.Rds')
#load("C:/Users/idcvdken/Dropbox (LSoHaTM)/r_cxb/dashboard/cxb_dashboard/data/gsheet_data.RData")
### All cases

#all_cases_raw <- gsheet_data$host_fdmn_append %>% clean_names()
fdmn_raw <- gsheet_data$fdmn %>% 
  clean_names() %>% 
    janitor::remove_empty() %>% 
    select(-date_of_death) %>% 
  mutate(camp_of_residence=as.character(camp_of_residence))

host_raw <- gsheet_data$host %>% 
  clean_names() %>% 
  janitor::remove_empty()

all_cases_raw <- fdmn_raw %>% 
  bind_rows(host_raw)

all_date_cols <- grep("(date|created_at| updated_on)", names(all_cases_raw))

all_cases_linelist <- all_cases_raw %>% clean_dates( force_Date  = all_date_cols,
                                                     guess_dates = all_date_cols) %>% 
  #mutate(camp=as.numeric(camp_of_residence)) %>% 
  mutate(population_group=case_when(nationality=='FDMN' ~ 'Rohingya refugee/FDMN',
                                    nationality=='Host' ~ 'Host community')) %>% 
    mutate(upazilla=case_when(upazilla=='CXB Sadar' ~ 'Sadar', 
                            TRUE~upazilla)) %>% 
  filter(!(is.na(population_group))) 
  

### Testing data

tests_data <- gsheet_data$testing %>% 
  clean_names() 

test_nationality <- tests_data %>% 
    filter(!date %in% c('NULL', 'Total')) %>% 
  #mutate(host_positivity=(host_positive/host)) %>% 
  #mutate(fdmn_positivity=(fdmn_positive/fdmn)) %>% 
    mutate(date_format=excel_numeric_to_date(as.numeric(date))) %>% 
    select(-date) %>% 
    pivot_longer(-date_format) %>% 
  mutate(population_group=case_when(grepl('fdmn',name) ~ 'Rohingya refugee/FDMN',
                                    grepl('host',name) ~ 'Host community')) 

##DRU data
dru_raw <- gsheet_data$dru %>% clean_names() %>%   mutate(facility_name=gsub(":([[:alpha:]])", ": \\1", facility_name)) 
quarantine_raw <- gsheet_data$quarantine %>% clean_names() %>% filter(!is.na(facility_name))


### Camp population

# camp_population <- read.csv(here('data', 'camp_population.csv')) %>% 
#   mutate(camp=as.numeric(camp))

#Population 
population <- read.csv(here('data', 'population.csv')) 


### GoData
# drop_download(path = '/cxb/cases.Rds',
#               local_path = 'cases.Rds', 
#               dtoken = token, 
#               overwrite = TRUE)
# 
# cases <- readRDS('cases.Rds')


url <- "https://godata-r4.who.int/"                   # <--------------------- insert instance url here, don't forget the slash at end !
username <- "david.kennedy@lshtm.ac.uk"                           # <--------------------- insert your username for signing into Go.Data webapp here
password <- "tEssAmAIsIE150!"                           # <--------------------- insert your password for signing into Go.Data webapp here
outbreak_id <- "9116fb0c-2b2e-424f-9252-accaf574e785"   # <--------------------- insert your outbreak ID here

#get access token
url_request <- paste0(url,"api/oauth/token?access_token=123")

response <- POST(url=url_request,
                 body = list(
                   username = username,
                   password = password),
                 encode = "json")

content <-
  content(response, as = "text") %>%
  fromJSON(flatten = TRUE)

access_token <- content$response$access_token                 ## this is your access token !!! that allows API calls

#specify date ranges, for follow up filters
date_now <- format(Sys.time(), "%Y-%m-%dT23:59:59.999Z")
date_21d_ago <- format((Sys.Date()-21), "%Y-%m-%dT23:59:59.999Z")

# import outbreak Cases
response_cases <- GET(paste0(url,"api/outbreaks/",outbreak_id,"/cases"),
                      add_headers(Authorization = paste("Bearer", access_token, sep = " "))
)
json_cases <- content(response_cases, as = "text")


cases <- as_tibble(fromJSON(json_cases, flatten = TRUE)) %>% 
  select(-c(firstName,middleName,lastName, addresses))


### Tables
# drop_download(path = '/cxb/tables.Rds',
#               local_path = 'tables.Rds', 
#               dtoken = token, 
#               overwrite = TRUE)
# 
# tables <- readRDS('tables.Rds')

host_population <-  2805491
fdmn_population <-  859205 



```

```{r table_wranging}

host_population <-  2805491
fdmn_population <-  859205 


#Cases
cxb_cases <- all_cases_linelist %>% 
  group_by(population_group,date_of_case_detection) %>% 
  summarise(n = n(),.groups = 'drop') %>% 
  select(date=date_of_case_detection, population_group, new_cases=n)

#Deaths
cxb_deaths <- all_cases_linelist %>% 
  filter(x30_day_outcome=='Death') %>% 
  group_by(population_group,date_of_case_detection) %>% 
  summarise(n = n(),.groups = 'drop') %>% 
  select(date=date_of_case_detection, population_group, new_deaths=n)

#Tests
cxb_tests <- tests_data %>%  
  filter(!date %in% c('NULL', 'Total')) %>% 
  mutate(date_format=excel_numeric_to_date(as.numeric(date)))  %>% 
  select(date=date_format, fdmn, host,) %>% 
  pivot_longer(-date) %>% 
  select(date, population_group=name, new_tests=value) %>% 
  mutate(population_group=case_when(grepl('fdmn', population_group) ~ 'Rohingya refugee/FDMN',
                                    TRUE ~ 'Host community')) 
#Bangladesh data
bgd_data <- fread('https://covid.ourworldindata.org/data/owid-covid-data.csv') %>% 
  filter(iso_code=='BGD') %>%        
  mutate(date_format=ymd(date)) %>% 
  select(date=date_format, new_tests,new_cases,new_deaths,population) %>% 
  mutate(population_group='Bangladesh')

first_date <- min(bgd_data$date)
last_date <- today()

#Combine CXB data

cxb_table_data <- cxb_tests %>% 
  full_join(cxb_cases, by=c('population_group', 'date')) %>% 
  full_join(cxb_deaths, by=c('population_group', 'date')) %>% 
  mutate(population=case_when(population_group=='Rohingya refugee/FDMN' ~ fdmn_population, 
                              TRUE ~ host_population)) 
rm(cxb_cases, cxb_deaths,cxb_tests)


#Combine Bangaladesh and CXB data
table_final_df <- bgd_data %>% 
  bind_rows(cxb_table_data) %>% 
  arrange(date, population_group) %>% 
  ungroup()

rm(bgd_data, cxb_table_data)
#Totals
table_totals <- table_final_df %>% 
 # ungroup() %>% 
  group_by(population_group, population) %>% 
  summarise(total_tests=sum(new_tests, na.rm=TRUE),
            total_cases=sum(new_cases, na.rm=TRUE),
            total_deaths=sum(new_deaths, na.rm=TRUE)) %>% 
  mutate(total_tests_pm=(total_tests/population)*1*10E5,
         total_cases_pm=(total_cases/population)*1*10E5,
         total_deaths_pm=(total_deaths/population)*1*10E5) %>% 
  select(-population)

#7-day
table_7day <- table_final_df %>% 
 # ungroup() %>% 
  filter(date > today() -7) %>% 
  group_by(population_group, population) %>% 
  summarise(total_tests_7day=sum(new_tests, na.rm=TRUE),
            total_cases_7day=sum(new_cases, na.rm=TRUE),
            total_deaths_7day=sum(new_deaths, na.rm=TRUE)) %>% 
  mutate(total_tests_pm_7day=(total_tests_7day/population)*1*10E5,
         total_cases_pm_7day=(total_cases_7day/population)*1*10E5,
         total_deaths_pm_7day=(total_deaths_7day/population)*1*10E5)%>% 
  select(-population)

#1-day
# table_1day <- table_final_df %>% 
#  # ungroup() %>% 
#   filter(date > today() -1) %>% 
#   group_by(population_group, population) %>% 
#   summarise(total_tests_1day=sum(new_tests, na.rm=TRUE),.groups = 'drop',
#             total_cases_1day=sum(new_cases, na.rm=TRUE),.groups = 'drop',
#             total_deaths_1day=sum(new_deaths, na.rm=TRUE),.groups = 'drop') %>% 
#   mutate(total_tests_pm_1day=(total_tests_1day/population)*1*10E5,
#          total_cases_pm_1day=(total_cases_1day/population)*1*10E5,
#          total_deaths_pm_1day=(total_deaths_1day/population)*1*10E5)%>% 
#   select(-population)

 # summarise(total_tests=sum(value,na.rm=TRUE),.groups = 'drop')

#Growth rate

growth_rate <- table_final_df %>% 
  group_by(population_group) %>% 
  mutate(new_cases=coalesce(new_cases,0)) %>% 
  mutate(cumulative_cases=cumsum(new_cases)) %>%
  mutate(case_growth=ifelse(lag(cumulative_cases,7)>10, 
                            ((cumulative_cases/lag(cumulative_cases,7))^(1/7))-1,NA)) %>%
                              summarise(case_growth=last(case_growth))

#Final calculations
table_calc_comb <- table_totals %>% 
  left_join(table_7day, by='population_group') %>% 
  left_join(growth_rate, by='population_group') %>% 
  mutate(test_pos=total_cases/total_tests, 
         cfr=total_deaths/total_cases)

rm(table_totals,table_7day,growth_rate)

```


Landing page
=====================================  


Row {data-height=75}
-------------------------------------

### 

```{r}

 valueBox(
  format(paste0('Host community'), big.mark = ","),
  icon= "",
  color= "#ED7D31"
)

```


### Tests: Total (Last 7 days)

```{r}

host_tests <- table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_tests)
host_tests_7day <- table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_tests_7day)

 valueBox(
  format(paste0(host_tests,' (', host_tests_7day, ')'), big.mark = ","),
  icon= "fas fa-vials",
  color= "#ED7D31"
)


```

### Cases: Total (Last 7 days)

```{r}
host_cases <- table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_cases)
host_cases_7day <- table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_cases_7day)
               
 valueBox(
  format(paste0(host_cases,' (', host_cases_7day, ')'), big.mark = ","),
  icon = "fas fa-user-md",
  color= "#ED7D31"
)

```

### Deaths: Total (Last 7 days)

```{r}
host_deaths <- table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_deaths)
host_deaths_7day <- table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_deaths_7day)
               
 valueBox(
  format(paste0(host_deaths,' (', host_deaths_7day, ')'), big.mark = ","),
  icon = "fas fa-procedures",
  color= "#ED7D31"
)


```

Row {data-height=75}
-------------------------------------

### 

```{r}

 valueBox(
  format(paste0('Rohingya/FDMN'), big.mark = ","),
  icon= "",
  color= "#4472C4"
)

```



### Tests: Total (Last 7 days)

```{r}

fdmn_tests <- table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_tests)
fdmn_tests_7day <- table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_tests_7day)
               
 valueBox(
  format(paste0(fdmn_tests,' (', fdmn_tests_7day, ')'), big.mark = ","),
  icon= "fas fa-vials",
  color= "#4472C4"
)

```

### Cases: Total (Last 7 days)

```{r}
fdmn_cases <- table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_cases)
fdmn_cases_7day <- table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_cases_7day)
               
 valueBox(
  format(paste0(fdmn_cases,' (', fdmn_cases_7day, ')'), big.mark = ","),
  icon = "fas fa-user-md",
  color= "#4472C4"
)

```

### Deaths: Total (Last 7 days)

```{r}
fdmn_deaths <- table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_deaths)
fdmn_deaths_7day <- table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_deaths_7day)
               
 valueBox(
  format(paste0(fdmn_deaths,' (', fdmn_deaths_7day, ')'), big.mark = ","),
  icon = "fas fa-procedures",
  color= "#4472C4"
)

```




Row {data-height=150}
-------------------------------------




```{r eval=FALSE, include=FALSE}
df <- data.frame(
  x = rep(seq(2, 15, 6.5), 2),
  y = c(rep(6.5, 3), rep(2,3)),
  h = rep(4.25, 6),
  w = rep(6.25, 6),
  value = c(paste0(table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_tests), ' (',
                   table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_tests_7day),')'),
            paste0(table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_cases),' (',
                   table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_cases_7day),')'),
            paste0(table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_deaths),' (',
                   table_calc_comb %>%  filter(population_group=='Rohingya refugee/FDMN') %>%  pull(total_deaths_7day),')'),
            paste0(table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_tests),' (',
                   table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_tests_7day),')'),
            paste0(table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_cases),' (',
                   table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_cases_7day),')'),
            paste0(table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_deaths),' (',
                   table_calc_comb %>%  filter(population_group=='Host community') %>%  pull(total_deaths_7day),')')),
  info = c("Tests - FDMN/Rohingya \n Total  (7 days)",
           "Cases - FDMN/Rohingya \n Total  (7 days)",
           "Deaths - FDMN/Rohingya \n Total  (7 days)",
           "Tests - Host \n Total  (7 days)",
           "Cases - Host \n Total  (7 days)",
           "Deaths - Host \n Total  (7 days)"),
  shape = '',
  font_family = c(rep("fontawesome-webfont", 6)),
  color = factor(1:6)
)


ggplot(df, aes(x, y, height = h, width = w, label = info)) +
  geom_tile(aes(fill = color)) +
  geom_text(color = "white", fontface = "bold", size = 10,
            aes(label = value, x = x - 2.9, y = y + 1), hjust = 0) +
  geom_text(color = "white", fontface = "bold",
            aes(label = info, x = x - 2.9, y = y - 1), hjust = 0) +
  coord_fixed() +
  scale_fill_brewer(type = "qual",palette = "Dark2") +
  geom_text(size = 20, aes(label = shape, family = font_family,
                           x = x + 1.5, y = y + 0.5), alpha = 0.25) +
  theme_void() +
  guides(fill = FALSE)


```

### Tests
```{r tests_tab}

table_calc_comb %>% 
  ungroup() %>%
  select(population_group, contains('test')) %>% 
  gt(rowname_col = "population_group") %>% 
  tab_stubhead(label = "Population group") %>% 
  cols_label(
    total_tests = "Total",
    total_tests_pm = "Per million",
    total_tests_7day = "Last 7 days", 
    total_tests_pm_7day   = "Per million",
    test_pos = "Test positivity" 
  ) %>% 
  # tab_spanner(
  #   label = "Tests",
  #   columns = vars(total_tests, total_tests_pm,total_tests_7day,total_tests_pm_7day,test_pos)
  # ) %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  fmt_percent(
    columns = vars(test_pos),
    decimals = 1
  ) %>% 
  fmt_number(
    columns=vars(total_tests_pm,total_tests_pm_7day),
    decimals = 1
  )

```

### Cases

```{r case_tab}

table_calc_comb %>% 
  ungroup() %>%
  select(population_group, contains('case')) %>% 
  gt(rowname_col = "population_group") %>% 
  tab_stubhead(label = "Population group") %>% 
  cols_label(
    total_cases = "Total",
    total_cases_pm = "Per million",
    total_cases_7day = "Last 7 days",
    total_cases_pm_7day   = "Per million",
    case_growth = "Growth rate"
  ) %>% 
  # tab_spanner(
  #   label = "Cases",
  #   columns = vars(total_cases, total_cases_pm,total_cases_7day,total_cases_pm_7day,case_growth)
  # ) %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  fmt_percent(
    columns = vars(case_growth),
    decimals = 1
  ) %>% 
  fmt_number(
    columns=vars(total_cases_pm, total_cases_pm_7day),
    decimals = 1
  )


```

### Deaths

```{r deaths_tab}
table_calc_comb %>% 
  ungroup() %>%
  select(population_group, contains('death'), cfr) %>% 
  gt(rowname_col = "population_group") %>% 
  tab_stubhead(label = "Population group") %>% 
  cols_label(
    total_deaths = "Total",
    total_deaths_pm = "Per million", 
    total_deaths_7day = "Last 7 days",
    total_deaths_pm_7day  = "Per million", 
    cfr = "Case Fatality Risk"
  ) %>% 
  # tab_spanner(
  #   label = "Deaths",
  #   columns = vars(total_deaths, total_deaths_pm,total_deaths_7day,total_deaths_pm_7day, cfr)
  # ) %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  fmt_percent(
    columns = vars(cfr),
    decimals = 1
  ) %>% 
  fmt_number(
    columns=vars(total_deaths_pm,total_deaths_pm_7day),
    decimals = 1
  )
```





```{r eval=FALSE, include=FALSE}
### Graph

test_growth_rate <- cxb_bgd_data %>% 
  group_by(population_group) %>% 
  mutate(new_tests=coalesce(new_tests,0)) %>% 
  mutate(cumulative_tests=cumsum(new_tests)) %>% 
  #summarise(total_tests= sum(new_tests, na.rm=TRUE)) %>% 
  #mutate(tests_per_million=(total_tests/population)*1000000) %>% 
  #mutate(tests_per_million=round(tests_per_million,0)) %>% 
  select(date,population_group, cumulative_tests) %>% 
  mutate(test_growth=ifelse(lag(cumulative_tests,7)>10,
                           ((cumulative_tests/lag(cumulative_tests,7))^(1/7))-1,NA))

test_growth_gph <- test_growth_rate %>% 
  filter(date>=ymd('2020-05-01')) %>% 
ggplot(aes(x=date, test_growth, color=population_group)) +
  geom_line() +
  labs(x = "Date",
       y = "Test growth rate",
       color="") +
  theme_tufte() +
  theme(legend.position="top") +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '3 day',
               date_labels = '%d-%m') +
  scale_y_continuous(labels = scales::percent)


case_growth_rate <- cxb_bgd_data %>% 
  group_by(population_group) %>% 
  mutate(new_cases=coalesce(new_cases,0)) %>% 
  mutate(cumulative_cases=cumsum(new_cases)) %>% 
  #summarise(total_tests= sum(new_tests, na.rm=TRUE)) %>% 
  #mutate(tests_per_million=(total_tests/population)*1000000) %>% 
  #mutate(tests_per_million=round(tests_per_million,0)) %>% 
  select(date,population_group, cumulative_cases) %>% 
  mutate(case_growth=ifelse(lag(cumulative_cases,7)>10,
                            ((cumulative_cases/lag(cumulative_cases,7))^(1/7))-1,NA))

case_growth_gph <- case_growth_rate %>% 
  filter(date>=ymd('2020-05-01')) %>% 
  ggplot(aes(x=date, case_growth, color=population_group)) +
  geom_line() +
  labs(x = "Date",
       y = "Case growth rate",
       color="") +
  theme_tufte() +
  theme(legend.position="top") +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '3 day',
               date_labels = '%d-%m') +
  scale_y_continuous(labels = scales::percent)



ggarrange(test_growth_gph, case_growth_gph, ncol=2, common.legend = TRUE, legend="top")


```

Row {data-height=250}
-------------------------------------

### Cases by date  

```{r epicurve}

epi_curve <- table_final_df %>% 
  mutate(week=epiweek(date)) %>% 
  #filter(date_detect>=ymd('2020-05-01')) %>% 
  filter(week>=19) %>% 
ggplot(.) +
  geom_col(aes(x = date, y = new_cases)) +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '7 day',
               date_labels = '%d-%m') +
  theme_minimal() +
  #plot_settings +
  labs(x = "Date case reported",
       y = "Number of cases") +
  facet_wrap(~ population_group, scales="free_y", ncol=1)

ggplotly(epi_curve)


```


### Test positivity trend

```{r test postivity}
test_positivity_gph <- test_nationality %>% 
  filter(name %in% c('host', 'fdmn','host_positive', 'fdmn_positive')) %>% 
  mutate(week=epiweek(date_format)) %>% 
  #filter(date_detect>=ymd('2020-05-01')) %>% 
  filter(week>=19) %>% 
  mutate(population_group=factor(population_group)) %>% 
  mutate(indicator=case_when(grepl('positive', name) ~ 'Case', 
                             TRUE ~ 'Test')) %>% 
  select(-c(name)) %>% 
  pivot_wider(names_from=indicator) %>% 
  group_by(population_group) %>% 
  mutate(tests_roll=roll_mean((Test),7, na.rm=TRUE, align="right", fill = NA)) %>% 
  mutate(cases_roll=roll_mean((Case),7, na.rm=TRUE, align="right", fill = NA)) %>% 
  mutate(pos_roll=cases_roll/tests_roll) %>% 
  ggplot(., aes(x=date_format, y=pos_roll, color=population_group)) +
  geom_line()  +
  scale_fill_manual(values=c("#ED7D31","#4472C4")) +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '7 day',
               date_labels = '%d-%m') +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  labs(caption="Data source: Lab data",
       x = "Date of test",
       y = "Test positivity (%) (7-day average)",
       color="Population group") +
  theme_minimal()

ggplotly(test_positivity_gph)

```



Row {data-height=100}
-------------------------------------

### Additional Resources


  + [WHO Bangaladesh Rohingya Crisis](https://www.who.int/bangladesh/emergencies/Rohingyacrisis/bulletin-and-reports){target="_blank"}

  + [SOPs](https://ln2.sync.com/dl/f29c53860/2hqhzj3x-q476hijz-sf8admz2-9b8793y9){target="_blank"}
  
  + [Field manuals](https://ln2.sync.com/dl/77f93df70/czt8mutv-8rcug6ge-erffrmd5-5s9i76c3){target="_blank"}
  
  + [Infographics](https://ln2.sync.com/dl/8da6ec810/f8q6b3c7-vgnyxh76-cepdkgqu-e2q4d9na){target="_blank"}
  
  + [Healthcare facility monitoring (Live Dashboard)](https://worldhealthorg.shinyapps.io/cxb_dru_dashboard){target="_blank"}
  

### Partners





```{r, echo=FALSE,fig.cap="This dashboard was developed by the [UK Public Health Rapid Support Team](https://www.lshtm.ac.uk/research/centres-projects-groups/uk-phrst){target='_blank'}", fig.align='center'} 

#knitr::include_graphics(c("data/health_sector_logo_size.png","data/who_bgd_logo_size.png"))
knitr::include_graphics(here('data', 'logo_comb.png'))

#knitr::include_graphics(c(here("'data','bgd_logo.png'","data/who_bgd_logo.png"))
#knitr::include_graphics(here('data', 'logo.png'), dpi = 100)

s <- now("UTC-6")

```






### Contact details

If you have any questions contact -----




Data updated at - "`r s`"


```{r data_formatting}

#Cases
cxb_cases_subloc <- all_cases_linelist %>% 
  group_by(population_group,date_of_case_detection,upazilla, camp_of_residence) %>% 
  summarise(n = n(),.groups = 'drop') %>% 
  select(date=date_of_case_detection, population_group,upazilla, camp_of_residence, new_cases=n)

#Deaths
cxb_deaths_subloc <- all_cases_linelist %>% 
  filter(x30_day_outcome=='Death') %>% 
  group_by(population_group,date_of_case_detection,upazilla, camp_of_residence) %>% 
  summarise(n = n(),.groups = 'drop') %>% 
  select(date=date_of_case_detection, population_group,upazilla, camp_of_residence, new_deaths=n)

cxb_cases_deaths_subloc <- cxb_cases_subloc %>% 
  full_join(cxb_deaths_subloc, by=c('population_group', 'date', 'upazilla', 'camp_of_residence')) %>% 
  mutate(location=coalesce(as.character(camp_of_residence),upazilla)) %>% 
  full_join(., population, by='location') %>% 
  filter(!is.na(population_group))

rm(cxb_cases_subloc, cxb_deaths_subloc)

#Totals
table_totals_subloc <- cxb_cases_deaths_subloc %>% 
  ungroup() %>% 
  group_by(population_group, population, location) %>% 
  summarise(total_cases=sum(new_cases, na.rm=TRUE),
            total_deaths=sum(new_deaths, na.rm=TRUE)) %>% 
  mutate(total_cases_pm=(total_cases/population)*1*10E5,
         total_deaths_pm=(total_deaths/population)*1*10E5) %>% 
    ungroup() %>% 
  select(-population)

#7-day
table_7day_subloc <- cxb_cases_deaths_subloc %>% 
  ungroup() %>% 
  filter(date > today() -7) %>% 
  group_by(population_group, population, location) %>% 
  summarise(total_cases_7day=sum(new_cases, na.rm=TRUE),
            total_deaths_7day=sum(new_deaths, na.rm=TRUE)) %>% 
  mutate(total_cases_pm_7day=(total_cases_7day/population)*1*10E5,
         total_deaths_pm_7day=(total_deaths_7day/population)*1*10E5)%>% 
  ungroup() %>% 
  select(-population)


#Growth rate
##Growth rate needs values larger than 10 so FDMN communities don't reach this criteria
growth_rate_subloc <- cxb_cases_deaths_subloc %>% 
  group_by(population_group,location) %>% 
  mutate(new_cases=coalesce(new_cases,0)) %>% 
  mutate(cumulative_cases=cumsum(new_cases)) %>%
  mutate(case_growth=ifelse(lag(cumulative_cases,7)>10, 
                            ((cumulative_cases/lag(cumulative_cases,7))^(1/7))-1,NA)) %>%
  summarise(case_growth=last(case_growth)) 


#Final calculations
table_calc_comb_subloc <- table_totals_subloc %>% 
  left_join(table_7day_subloc, by=c('population_group','location')) %>% 
  left_join(growth_rate_subloc, by=c('population_group','location')) %>% 
  mutate( cfr=total_deaths/total_cases)

rm(table_totals_subloc, table_7day_subloc,growth_rate_subloc)


```




Host community  {data-orientation=columns}
=====================================  

Row 
-------------------------------------
   
### Table {data-height=650}


```{r}
host_table_data <- table_calc_comb %>% 
  filter(grepl('host', population_group, ignore.case = T)) %>% 
  mutate(location="Total") %>% 
  select(c(population_group,location,total_cases,total_deaths,total_cases_pm,total_deaths_pm,total_cases_7day,total_deaths_7day,   
 total_cases_pm_7day,total_deaths_pm_7day,case_growth,cfr)) 

#Host 
summaryTable_host <- table_calc_comb_subloc %>% 
  ungroup() %>%
  filter(grepl('host', population_group, ignore.case=T)) %>% 
  bind_rows(host_table_data) %>% 
  select(-c(population_group,total_deaths_pm,total_deaths_pm_7day)) %>% 
  gt() %>% 
    tab_header(
    title = "Host Community Summary",
    subtitle = ""
  ) %>% 
  cols_label(
    location = "Upazilla",
    total_cases = "Total",
    total_deaths = "Total",
    total_cases_pm = "Per million",
    #total_deaths_pm = "Per million", 
    total_cases_7day = "Last 7 days",
    total_deaths_7day = "Last 7 days",
    total_cases_pm_7day   = "Per million",
    #total_deaths_pm_7day  = "Per million", 
    cfr = "Case Fatality Risk", 
    case_growth = "Growth rate"
  ) %>% 
  tab_spanner(
    label = "Cases",
    columns = vars(total_cases, total_cases_pm,total_cases_7day,total_cases_pm_7day,case_growth)
  ) %>% 
  tab_spanner(
    label = "Deaths",
    columns = vars(total_deaths,total_deaths_7day, cfr)
  ) %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  fmt_percent(
    columns = vars(case_growth, cfr),
    decimals = 1
  ) %>% 
  fmt_number(
    columns=vars(total_cases_pm, total_cases_pm_7day),
    decimals = 1
  ) %>% 
  tab_source_note("Data Source: FDMN/Host Linelist") %>% 
  tab_options(
    container.overflow.x = TRUE,
    container.overflow.y = TRUE,
    grand_summary_row.background.color = "lightblue")

summaryTable_host
```   

### Tests and cases over time {data-height=350}

```{r daily_tests}

testing_host_gph <-  test_nationality %>% 
      filter(name %in% c('host', 'host_positive')) %>% 
       mutate(name_fac=factor(name,levels=c('host', 'host_positive'), 
                         labels=c('Tests', 'Cases'))) %>% 
  ggplot(., aes(x=date_format, y=value, fill=name_fac)) +
  geom_bar(stat="identity",position ="identity")   +
    scale_fill_manual(values=c("#ED7D31","#4472C4")) +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '3 day',
               date_labels = '%d-%m') +
  labs(caption="Data source: Lab data",
       x = "Date",
       y = "Count",
       fill="") +
  theme_minimal()

ggplotly(testing_host_gph)


```



Column 
-------------------------------------


### Map


```{r host_map}


shp_file_host <- read_sf(here('data', 'shapefiles', 'cxb_shp.shp'))


case_shp_host <- table_calc_comb_subloc %>% 
  filter(population_group=='Host community') %>% 
  #mutate(code=location) %>% 
  rename(upazilla = location) %>% 
  select(upazilla,total_cases, total_deaths) %>% 
  left_join(shp_file_host,.,by='upazilla')


map_host  <- tm_shape(case_shp_host) + 
  tm_polygons("total_cases", 
              style = "fixed",
              breaks = c(0, 100, 250, 500,1000,2000),
              title="Confirmed COVID-19 cases", 
              palette='YlOrRd', 
              id="total_cases", alpha=0.5) +   
  tm_text("upazilla", root=5) +
  tm_legend(text.size=1,
            title.size=1.2,
            position = c("left","bottom"), 
            bg.color = "white", 
            bg.alpha=.2, 
            width=.8,
            frame="white", 
            height=.6) 

tmap_leaflet(map_host)

```


 
 
Rohingya refugee/FDMN {data-orientation=columns}
=====================================  

Row 
-------------------------------------
   
### Table {data-height=650}
    
```{r}

# prepare regular expression
regexp <- "[[:digit:]]+"

fdmn_table_data <- table_calc_comb %>% 
  filter(grepl('fdmn', population_group, ignore.case = T)) %>% 
  mutate(location="Total") %>% 
  select(c(population_group,location,total_cases,total_deaths,total_cases_pm,total_deaths_pm,total_cases_7day,total_deaths_7day,   
           total_cases_pm_7day,total_deaths_pm_7day,case_growth,cfr)) 

#FDMN 
summaryTable_fdmn <- table_calc_comb_subloc %>% 
  ungroup() %>%
  filter(grepl('fdmn', population_group, ignore.case=T)) %>% 
  bind_rows(fdmn_table_data) %>% 
  mutate(location=case_when(grepl('ukhia', location, ignore.case=T)~'Camp missing (Ukhia)',
                            grepl('teknaf', location, ignore.case=T)~'Camp missing (Teknaf)',
                            TRUE ~ location)) %>% 
  #mutate(total_cases_pm=ifelse())
  mutate(total_cases_pm=ifelse(grepl('ukhia', location, ignore.case=T),NA, 
                               ifelse(grepl('teknaf', location, ignore.case=T), NA, total_cases_pm))) %>% 
  # mutate(total_deaths_pm=ifelse(grepl('ukhia', location, ignore.case=T),NA, 
  #                             ifelse(grepl('teknaf', location, ignore.case=T), NA, total_deaths_pm))) %>% 
  mutate(total_cases_pm_7day=ifelse(grepl('ukhia', location, ignore.case=T),NA, 
                                    ifelse(grepl('teknaf', location, ignore.case=T), NA, total_cases_pm_7day))) %>% 
  #  mutate(total_deaths_pm_7day=ifelse(grepl('ukhia', location, ignore.case=T),NA, 
  #                              ifelse(grepl('teknaf', location, ignore.case=T), NA, total_deaths_pm_7day))) %>% 
  mutate(camp=location) %>% 
  #arrange(camp) %>% 
  mutate(camp_number=str_extract(camp, regexp)) %>% 
  mutate(camp_number=as.numeric(camp_number)) %>% 
  arrange(camp_number) %>% 
  select(-c(population_group,camp,total_deaths_pm,total_deaths_pm_7day,camp_number)) %>% 
  gt() %>% 
  # tab_header(
  #   title = "Rohingya refugee/FDMN Summary",
  #   subtitle = ""
  # ) %>% 
  cols_label(
    location = "Camp",
    total_cases = "Total",
    total_deaths = "Total",
    total_cases_pm = "Per million",
    #total_deaths_pm = "Per million", 
    total_cases_7day = "Last 7 days",
    total_deaths_7day = "Last 7 days",
    total_cases_pm_7day   = "Per million",
    # total_deaths_pm_7day  = "Per million", 
    cfr = "Case Fatality Risk", 
    case_growth = "Growth rate"
  ) %>% 
  tab_spanner(
    label = "Cases",
    columns = vars(total_cases, total_cases_pm,total_cases_7day,total_cases_pm_7day,case_growth)
  ) %>% 
  tab_spanner(
    label = "Deaths",
    columns = vars(total_deaths,total_deaths_7day, cfr)
  ) %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  fmt_percent(
    columns = vars(case_growth, cfr),
    decimals = 1
  ) %>% 
  fmt_number(
    columns=vars(total_cases_pm, total_cases_pm_7day),
    decimals = 1
  ) %>% 
  tab_source_note("Data Source: FDMN/Host Linelist") %>% 
  tab_options(
    container.overflow.x = TRUE,
    container.overflow.y = TRUE,
    grand_summary_row.background.color = "lightblue") %>% 
  fmt_missing(
    columns = 2:8,
    missing_text = "-"
  ) %>% 
  tab_footnote(
    footnote = "Growth rate can only be calculated when there have been at least 10 cases",
    locations = cells_column_labels(
      columns = vars(case_growth))
  )



summaryTable_fdmn
```


### Tests and cases over time {data-height=350}

```{r}

    
testing_fdmn_gph <-  test_nationality %>% 
  filter(name %in% c('fdmn', 'fdmn_positive')) %>% 
       mutate(name_fac=factor(name,levels=c('fdmn', 'fdmn_positive'), 
                         labels=c('Tests', 'Cases'))) %>% 
  ggplot(., aes(x=date_format, y=value, fill=name_fac)) +
  geom_bar(stat="identity",position ="identity")   +
    scale_fill_manual(values=c("#ED7D31","#4472C4")) +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '3 day',
               date_labels = '%d-%m') +
  labs(caption="Data source: Lab data",
       x = "Date",
       y = "Count",
       fill="") +
  theme_minimal()


ggplotly(testing_fdmn_gph)
```



Column 
-------------------------------------

### Map

```{r fdmn_map}

shp_file_fdmn <- read_sf(list.files(here('data','shapefiles'), 
                                    pattern='1.shp$', 
                                    full.names = T)) %>% 
  
  clean_names() %>% 
  mutate(merge_col = case_when(code=='KRC' ~ 'Kutupalong RC',
                               code=='NRC' ~ 'Nyapara RC', 
         TRUE ~ code))

case_shp_fdmn <- table_calc_comb_subloc %>% 
  filter(population_group=='Rohingya refugee/FDMN') %>% 
  filter(!location %in% c('Ukhia', 'Teknaf')) %>% 
  mutate(code=location) %>% 
  select(code,total_cases, total_deaths) %>% 
  left_join(shp_file_fdmn,.,by=c('merge_col'='code'))

pal <- colorNumeric(
  palette = "YlOrRd",
  domain = case_shp_fdmn$total_cases)


map_fdmn <- case_shp_fdmn %>%
  mutate(camp=gsub('Camp', '', new_camp_n)) %>%
  tm_shape(.) +
  tm_polygons("total_cases", title="Confirmed COVID-19 cases", palette='YlOrRd', 
              id="total_cases", alpha=0.5, colorNA=NULL) +
  tm_text("camp", col="black", root=5) +
  tm_legend(text.size=1,
            title.size=1.2,
            position = c("left","bottom"),
            bg.color = "black",
            bg.alpha=.2,
            width=.8,
            frame="white",
            height=.6)
#tm_facets("upazila", ncol=1)
tmap_leaflet(map_fdmn)

```




Epidemiology {data-orientation=columns}
=====================================  

This tab shows information from GoData. The data are only from the FDMN/Rohingya population. 

Where there is a discrepancy between the total number of cases in this tab and the Rohingya tab, data have yet to be entered into GoData.


```{r epi_wranging}

godata_wide <- cases %>%
  clean_names() %>% 
  filter(deleted == FALSE) %>%
  unnest(c(
    #addresses,
    date_ranges,
    questionnaire_answers_health_facility,
    questionnaire_answers_status_at_detection,
    questionnaire_answers_outcome,
    questionnaire_answers_outcome_2,
    questionnaire_answers_msf_outcome,
    #questionnaire_answers_outcome2,
    #questionnaire_answers_nationality,
    #questionnaire_answers_nationality_2,
    #questionnaire_answers_cif_nationality,
    contains('nationality'),
    contains('result'),
    contains('symptom'),
    # questionnaireAnswers.numeroIDcasIndex,
    # questionnaireanswers_liendeparente
  ),
  keep_empty = TRUE, names_sep = "_") %>% 
    remove_empty(c("rows", "cols")) 


godata_clean <- godata_wide %>% 
  #Ethnicity
  mutate(population_group=coalesce(questionnaire_answers_nationality_value,questionnaire_answers_nationality_2_value,questionnaire_answers_cif_nationality_value)) %>% 
  filter(population_group=='FDMN')  %>% 
  #Test result
  mutate(lab_result=coalesce(questionnaire_answers_lab_result_value,questionnaire_answers_result_2_value)) %>% 
  filter(lab_result=='Positive') %>% 
  #Dates
  mutate(date_of_reporting = guess_dates(date_of_reporting),
         #date_of_data_entry = guess_dates(createdat),
         date_of_onset = guess_dates(date_of_onset),
         date_of_outcome = guess_dates(date_of_outcome),
         date_of_last_contact = guess_dates(date_of_last_contact),
         date_become_case = guess_dates(date_become_case)) %>% 
  #Age
  mutate(age_years = case_when(
    is.na(age_years) && !is.na(age_months) ~  as.integer(age_months / 12),
    #is.na(age_years) && is.na(age_months) ~  NA_integer_,
    TRUE ~ as.integer(age_years))) %>%
  #Age group
  mutate(age_group=cut(age_years,breaks = c(seq(0, 70, by = 10), Inf), labels = age_labs, right = FALSE)) %>%
  mutate(age_group=fct_explicit_na(age_group, na_level = "(outcome missing)")) %>% 
  #Classification
  filter(classification != "lng_reference_data_category_case_classification_not_a_case_discarded") %>%
  mutate(classification = case_when(
        grepl('confirmed', classification, ignore.case=TRUE) ~ "confirmed",
            grepl('suspect', classification, ignore.case=TRUE) ~ "suspect",
            grepl('probable', classification, ignore.case=TRUE) ~ "probable"
  )) %>%
  #Sex
  mutate(sex = case_when(
                grepl('_male', gender, ignore.case=TRUE) ~ "male",
        grepl('_female', gender, ignore.case=TRUE) ~ "female"
  )) %>% 
  #Updated this classification to match survey
  #updated to "outcome"
  mutate(outcome = case_when(
            grepl('alive', outcome_id, ignore.case=TRUE) ~ "alive",
            grepl('deceased', outcome_id, ignore.case=TRUE) ~ "dead",
            grepl('recovered', outcome_id, ignore.case=TRUE) ~ "recovered",
            #grepl('death', questionnaire_answers_outcome, ignore.case=TRUE) ~ "dead",
            grepl('healthy', questionnaire_answers_outcome_2_value, ignore.case=TRUE) ~ "alive",
            grepl('not recovered', questionnaire_answers_outcome_2_value, ignore.case=TRUE) ~ "alive",
            grepl('$recovered', questionnaire_answers_outcome_2_value, ignore.case=TRUE) ~ "recovered",
            grepl('death', questionnaire_answers_outcome_2_value, ignore.case=TRUE) ~ "dead"
  )) %>%
        mutate(outcome=fct_explicit_na(outcome, na_level = "(Outcome missing)"))  %>% 
  #Status at detection
  mutate(detection_status = questionnaire_answers_status_at_detection_value) %>%
  #Risk level
  mutate(risk_level = case_when(
            grepl('low', risk_level, ignore.case=TRUE) ~ "low",
            grepl('medium', risk_level, ignore.case=TRUE) ~ "medium",
            grepl('high', risk_level, ignore.case=TRUE) ~ "high"
  )) %>%
  #Updated available options
  mutate(status = case_when(
                grepl('hospitalization', date_ranges_typeId, ignore.case=TRUE) ~ "hospitalization",
                grepl('other', date_ranges_typeId, ignore.case=TRUE) ~ "other",
                grepl('isolation', date_ranges_typeId, ignore.case=TRUE) ~ "isolation"
  )) %>%
  mutate(pregnant = case_when(grepl('trimester', date_ranges_typeId, ignore.case=TRUE) ~ "pregnant"
  )) %>%
  mutate(pregnant=case_when(grepl('yes',questionnaire_answers_pregnant,ignore.case=TRUE)~1)) %>% 
  #Symptoms
  #Cough
  mutate(cough=case_when(grepl('cough',questionnaire_answers_respiratory_symptoms_value,ignore.case=TRUE)~1,
                         grepl('yes', questionnaire_answers_cough,ignore.case=TRUE)~1)) %>% 
  #Rapid breathing 
  mutate(rapid_breathing=case_when(grepl('rapid breathing',questionnaire_answers_respiratory_symptoms_value,ignore.case=TRUE)~1,
                         grepl('yes', questionnaire_answers_rapid_breathing,ignore.case=TRUE)~1)) %>%
  #Respiratory distress
  mutate(resp_distress=case_when(grepl('severe respiratory distress',questionnaire_answers_respiratory_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_acute_respiratory_distress_syndrome_ards,ignore.case=TRUE)~1)) %>% 
  #Runny nose
  mutate(runny_nose=case_when(grepl('Runny nose',questionnaire_answers_respiratory_symptoms_value,ignore.case=TRUE)~1,
                                 grepl('yes', questionnaire_answers_runny_nose,ignore.case=TRUE)~1)) %>% 
  #Fever
  mutate(fever=case_when(grepl('Fever',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_fever,ignore.case=TRUE)~1)) %>% 
  #Loss of smell 
  mutate(loss_smell=case_when(grepl('Loss of smell',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_loss_of_smell,ignore.case=TRUE)~1)) %>% 
  #Fatigue
  mutate(fatigue=case_when(grepl('Fatigue',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_fatigue,ignore.case=TRUE)~1)) %>% 
    #Loss of appetite
  mutate(loss_appetite=case_when(grepl('Loss of appetite',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_loss_of_appetite,ignore.case=TRUE)~1)) %>% 
     #Sore throat
  mutate(sore_throat=case_when(grepl('Sore throat',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_sore_throat,ignore.case=TRUE)~1)) %>% 
  #Diarrhoea
    mutate(diarrhoea=case_when(grepl('Diarrhoea',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_diarrhoea,ignore.case=TRUE)~1)) %>% 
  #Pre-existing conditions
  #Hypertension
  mutate(htn=case_when(grepl('hypertension',questionnaire_answers_select_pre_existing_medical_condition,ignore.case=TRUE)~1,
                         grepl('yes', questionnaire_answers_hypertension,ignore.case=TRUE)~1)) %>% 
  #Cardiovascular
  mutate(cardiovascular=case_when(grepl('cardiovascular',questionnaire_answers_select_pre_existing_medical_condition,ignore.case=TRUE)~1,
                       grepl('yes', questionnaire_answers_cardiovascular_disease,ignore.case=TRUE)~1)) %>% 
  #Diabetes
  mutate(diabetes=case_when(grepl('diabetes',questionnaire_answers_select_pre_existing_medical_condition,ignore.case=TRUE)~1,
                       grepl('yes', questionnaire_answers_diabetes,ignore.case=TRUE)~1)) %>% 
  #Lung disease
  mutate(lung_disease=case_when(grepl('chronic lung',questionnaire_answers_select_pre_existing_medical_condition,ignore.case=TRUE)~1,
                       grepl('yes', questionnaire_answers_chronic_lung_disease,ignore.case=TRUE)~1)) %>% 
  mutate(any_comorb=case_when(htn==1 ~ 1,
                              cardiovascular==1 ~ 1,
                              diabetes==1 ~ 1,
                              lung_disease==1 ~ 1)) %>% 
  #Time intervals
   unnest(questionnaire_answers_date_sample_collected,   keep_empty = TRUE, names_sep = "_") %>% 
  #Date of onset
  mutate(date_symptom_onset_final=ymd(date_of_onset)) %>% 
  #Date sample collected
  mutate(date_sample_collected=ymd_hms(questionnaire_answers_date_sample_collected_value)) %>% 
  mutate(date_sample_collected=as.Date(date_sample_collected)) %>% 
  mutate(onset_sample=as.integer(date_sample_collected-date_symptom_onset_final)) %>% 
  #Clean health facility variable
  mutate(health_facility_name=case_when(grepl('KTP', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'MSF / KTP Hospital',
                                      grepl('Leda', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'IOM Leda',
                                      grepl('Hope', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'Hope Foundation / Camp 4',
                                      grepl('BKL', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'MSF OCA BKL',
                                      grepl('5', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'UNHCR / Camp 5',
                                      grepl('8W', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'MSF / Camp 8 W',
                                      questionnaire_answers_health_facility_value=='MR ITC' ~ 'Main Road SARI ITC', 
                                      questionnaire_answers_health_facility_value=='MT ITC' ~ 'Main Road SARI ITC', 
                                      grepl('Main Road SARI ITC', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'Main Road SARI ITC',
                                      grepl('FH-MTI SARI ITC', questionnaire_answers_health_facility_value, ignore.case = T) ~ 'FH-MTI SARI ITC',
                                      TRUE ~ questionnaire_answers_health_facility_value)) %>% 
  #Contact with someone else
  mutate(contact_cov19=case_when(grepl('yes', questionnaire_answers_have_you_had_contact_with_an_anyone_with_suspected_or_confirmed_covid_19_infection, ignore.case=T) ~'Yes',
                                 grepl('no', questionnaire_answers_have_you_had_contact_with_an_anyone_with_suspected_or_confirmed_covid_19_infection, ignore.case=T)  ~'No',
                                 grepl('unknown', questionnaire_answers_have_you_had_contact_with_an_anyone_with_suspected_or_confirmed_covid_19_infection, ignore.case=T) ~'Unknown'))


  


```



```{r cases}

case_age_sex <- godata_clean %>% 
  count(sex,age_group, .drop = FALSE)

max_case <- max(case_age_sex$n)

case_age_sex_gph <- ggplot(case_age_sex,
                           aes(x = age_group,
                               y=n,
                               #y = ifelse(sex == 'male', n, -n),
                               fill = sex)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5) +
  scale_y_continuous(limits = c(0, max_case),
                     breaks = seq(0, max_case, 2),
                     labels = abs(seq(0, max_case, 2))) +
  labs(x = "Age", y = "Number of cases", fill = '') +
  theme_minimal()


```


```{r deaths}

death_age_sex <- godata_clean %>% 
  filter(outcome=='dead') %>% 
  count(sex,age_group, .drop = FALSE)

max_deaths <- max(death_age_sex$n)

death_age_sex_gph <- ggplot(death_age_sex,
                           aes(x = age_group,
                               y=n,
                               #y = ifelse(sex == 'male', n, -n),
                               fill = sex)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5) +
  scale_y_continuous(limits = c(0, max_case),
                     breaks = seq(0, max_case, 2),
                     labels = abs(seq(0, max_case, 2))) +
  labs(x = "Age", y = "Number of deaths", fill = '') +
  theme_minimal()

```


Row  
-------------------------------------



### Epi curve of COVID-19 cases

```{r}

epi_curve <- godata_clean %>% 
  #filter(classification=='confirmed') %>% 
  count(date_symptom_onset_final, sex) %>% 
  ggplot(.) +
  geom_col(aes(x = date_symptom_onset_final, y = n, fill=sex)) +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '3 day',
               date_labels = '%d-%m') +
  theme_minimal() +
  #plot_settings +
  labs(x = "Date of symptom onset",
       y = "Number of cases")

ggplotly(epi_curve)

```

### Cases and deaths by age group


```{r}
#ggarrange(case_age_sex_gph, death_age_sex_gph, ncol=2, common.legend = TRUE, legend="top")
#ggplotly(case_age_sex_gph)

 case_age <- godata_clean %>% 
    count(age_group, .drop = FALSE) %>% 
    mutate(indicator='Cases')
  
  max_cases <- max(case_age$n)
  
 death_age <- godata_clean %>% 
   filter(outcome=='dead') %>% 
    count(age_group, .drop = FALSE) %>% 
   mutate(indicator='Deaths')

case_death_age_gph <-  case_age %>% 
   bind_rows(death_age) %>% 
   ggplot(.,
          aes(x = age_group,
              y=n,
              #y = ifelse(sex == 'male', n, -n),
              fill = indicator)) +
   geom_bar(stat = "identity", position = "dodge", width = 0.7) +
   labs(x = "Age group", y = "Count", fill = '') +
   theme_minimal() +
   scale_y_continuous(breaks=seq(0,max_cases,2)) +
   geom_text(
     aes(label = ifelse(n>0,n,''), y = n + 0.05),
     position = position_dodge(0.9),
     vjust = 0
   ) 

ggplotly(case_death_age_gph)
 
```



Column 
-------------------------------------

### Detailed information on cases

```{r}
label(godata_clean$age_years) <- "Age"
label(godata_clean$sex) <- "Sex"
label(godata_clean$outcome) <- "Outcome"
label(godata_clean$questionnaire_answers_travel_outside_camps) <- "Travel outside camp (last 14 days)"
label(godata_clean$status) <- "Status"
#label(godata_clean$risk_level) <- "Risk level"
label(godata_clean$onset_sample) <- "Symptom onest to sample taken (days)"
label(godata_clean$health_facility_name) <- "Health facility"
label(godata_clean$outcome) <- "Patient outcome"
label(godata_clean$contact_cov19) <- "Did the case have contact with a suspected or confirmed COVID-19 case?"
label(godata_clean$any_comorb) <- "Did the case report a pre-existing condition?"
label(godata_clean$detection_status) <- "Status at detection"


table1(~ age_years  + sex  + 
         #health_facility_name  + 
         detection_status +
         outcome + contact_cov19 +
         #factor(cough) + factor(sore_throat) + factor(fever) + factor(rapid_breathing) + factor(resp_distress) +
         onset_sample  , data=godata_clean, topclass="Rtable1-zebra",footnote="Data source: GoData") 

```

 <!---
### Symptom profile

```{r symptoms}

 godata_clean %>% 
    select(id, cough, rapid_breathing, resp_distress, runny_nose, fever,loss_smell, fatigue, loss_appetite, sore_throat,diarrhoea) %>% 
    pivot_longer(-id) %>% 
    mutate(name = case_when(name=='cough' ~ 'Cough',
                            name=='rapid_breathing' ~ 'Rapid breathing',
                            name=='resp_distress' ~ 'Respiratory distress',
                            name=='runny_nose' ~ 'Runny nose',
                            name=='fever' ~ 'Fever',
                            name=='loss_smell' ~ 'Loss of smell',
                            name=='fatigue' ~ 'Fatigue',
                            name=='loss_appetite' ~ 'Loss of appetite',
                            name=='sore_throat' ~ 'Sore throat',
                            name=='diarrhoea' ~ 'Diarrhoea')) %>%
    filter(value==1) %>% 
    arrange(id, name) %>% 
    select(-value) %>% 
    group_by(id) %>%
    summarize(symptom_list = list(name)) %>% 
    ggplot(aes(x=symptom_list)) +
    geom_bar() +
    theme_bw() +
    labs(x = "",
         y = "Number of cases",
         #title="Distribution of symptoms at presentation",
         caption="Data source: GoData") +
    scale_x_upset( n_intersections = 5) 

```

--->

<!---

Surveillance  {data-orientation=columns}
=====================================  

### Test positivity over time

```{r test_positivity, eval=FALSE, include=FALSE}

##Test postiivity
# test <- test_nationality %>% 
#   filter(name %in% c('host', 'fdmn')) %>% 
#   mutate(week=epiweek(date_format)) %>% 
#   group_by(week, name) %>% 
#   summarise(total_tests=sum(value)) %>% 
#   mutate(name=case_when(grepl('host', name) ~ 'host',
#                         TRUE ~ 'fdmn')) %>% 
#   mutate(name_fac=factor(name, levels=c('host', 'fdmn'),
#                          labels=c('Host community', 'Rohingya refugee/FDMN'))) %>% 
#   select(-name)
# 
# 
# case <- test_nationality %>% 
#   filter(name %in% c('host_positive', 'fdmn_positive')) %>% 
#   mutate(week=epiweek(date_format)) %>% 
#   group_by(week, name) %>% 
#   summarise(total_cases=sum(value)) %>% 
#   mutate(name=case_when(grepl('host', name) ~ 'host',
#                         TRUE ~ 'fdmn')) %>% 
#   mutate(name_fac=factor(name, levels=c('host', 'fdmn'),
#                          labels=c('Host community', 'Rohingya refugee/FDMN')))%>% 
#   select(-name)
# 
# 
# test_positivity_gph <- test %>% 
#   left_join(case, by=c('week', 'name_fac')) %>% 
#   filter(week>=19) %>% 
#   mutate(pos=total_cases/total_tests) %>% 
#   ggplot(., aes(x=week, y=pos, color=name_fac)) +
#   geom_line() +
#   ##geom_bar(stat="identity", width=.5, position = "dodge") +
#   scale_y_continuous(labels = scales::percent) +
#   scale_fill_manual(values=c("#ED7D31","#4472C4")) +
#   labs(caption="Data source: Lab data",
#        x = "Week",
#        y = "Test positivity (%)",
#        fill="Population group") +
#   theme_minimal()


test_positivity_gph <- test_nationality %>% 
  filter(name %in% c('host', 'fdmn','host_positive', 'fdmn_positive')) %>% 
  mutate(week=epiweek(date_format)) %>% 
  #filter(date_detect>=ymd('2020-05-01')) %>% 
  filter(week>=19) %>% 
  mutate(population_group=factor(population_group)) %>% 
  mutate(indicator=case_when(grepl('positive', name) ~ 'Case', 
                             TRUE ~ 'Test')) %>% 
  select(-c(name)) %>% 
  pivot_wider(names_from=indicator) %>% 
  group_by(population_group) %>% 
  mutate(tests_roll=roll_mean((Test),7, na.rm=TRUE, align="right", fill = NA)) %>% 
  mutate(cases_roll=roll_mean((Case),7, na.rm=TRUE, align="right", fill = NA)) %>% 
  mutate(pos_roll=cases_roll/tests_roll) %>% 
  ggplot(., aes(x=date_format, y=pos_roll, color=population_group)) +
  geom_line()  +
  scale_fill_manual(values=c("#ED7D31","#4472C4")) +
  scale_x_date(date_breaks = '14 day', date_minor_breaks = '3 day',
               date_labels = '%d-%m') +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  labs(caption="Data source: Lab data",
       x = "Date",
       y = "Test positivity (%) (7-day average)",
       color="Population group") +
  theme_minimal()

ggplotly(test_positivity_gph)


```


### Mean age of ARI/ILI samples by week

```{r ari_ili_age}

ari_data <- gsheet_data$ari_ili %>% 
    clean_names() %>% 
    mutate(date_detect=ymd(date_of_case_detection),
           date_onset=date_of_onset_of_any_of_the_symptoms) %>% 
    select(nationality, date_detect, date_onset,sample_type, laboratory_result, age, sex)
  
  
  
mean_age_gph <- ari_data %>% 
  filter(!nationality=='UNK') %>% 
  mutate(name_fac=factor(nationality, levels=c('Host', 'FDMN'),
                         labels=c('Host community', 'Rohingya refugee/FDMN'))) %>% 
  mutate(week=epiweek(date_detect)) %>% 
  #filter(date_detect>=ymd('2020-05-01')) %>% 
  filter(week>=19) %>% 
  filter(laboratory_result=='Positive') %>% 
  group_by(week, name_fac) %>% 
  #summarise(mean_age=mean(age,na.rm=TRUE)) %>% 
  #ggplot(., aes(x=week, y=mean_age, fill=nationality)) +
  #geom_col(position="dodge")
  summarise(ci = list(mean_cl_normal(age) %>% 
                        rename(mean=y, lwr=ymin, upr=ymax))) %>% 
  unnest()  %>% 
  ggplot(., aes(x=week, y=mean, fill=name_fac)) +
  geom_bar(stat="identity", width=.75, position = "dodge") +
  geom_errorbar(aes(ymin=lwr, ymax=upr),
                width=.2,                    # Width of the error bars
                position=position_dodge(.9)) +
  scale_fill_manual(values=c("#ED7D31","#4472C4")) +
  labs(caption="Data source: ARI/ILI Linelist",
       x = "Week",
       y = "Age (years)",
       fill="Population group") +
  theme_minimal()


ggplotly(mean_age_gph)

```





{data-orientation=rows data-navmenu="Healthcare facility monitoring" data-icon="fa-list"}


Community mortality data  {data-orientation=rows}
=====================================  

--->


Testing  
=====================================  

```{r testing}

ari_ili_df <- gsheet_data$ari_ili %>% 
  clean_names() %>% 
  clean_data() %>% 
  #complete(date_of_case_detection = min(date_of_case_detection), max(date_of_case_detection), by = "day") %>% 
  mutate(camp=gsub('camp_', '', camp))


ari_ili_tests_df <- ari_ili_df %>% 
  filter(nationality=='fdmn') %>% 
  count(date_of_case_detection,camp) %>% 
  complete(date_of_case_detection,camp, fill = list(n = 0)) %>% 
  group_by(camp) %>%
  mutate(cumulative_cases=cumsum(n)) %>%
  mutate(case_growth=ifelse(lag(cumulative_cases,7)>10, 
                            ((cumulative_cases/lag(cumulative_cases,7))^(1/7))-1,NA)) %>%
  mutate(roll_test=roll_mean((n),7,  align="right", fill = NA)) %>% 
  mutate(week=epiweek(date_of_case_detection)) %>% 
  filter(week>=19) %>% 
  ungroup()

ari_ili_tests_total <- ari_ili_tests_df %>% 
  group_by(camp) %>% 
  summarise(tests_total=sum(n, na.rm=TRUE))

ari_ili_tests_7day <- ari_ili_tests_df %>% 
  filter(date_of_case_detection>=today()-7) %>% 
  group_by(camp) %>% 
  summarise(tests_7day=sum(n, na.rm=TRUE))

ari_ili_tests_growth <- ari_ili_tests_df %>% 
  select(camp, case_growth) %>% 
  group_by(camp) %>% 
  summarise(growth=last(case_growth))

ari_ili_tests_result <- ari_ili_df %>% 
  filter(nationality=='fdmn') %>% 
  count(camp, laboratory_result) %>% 
  group_by(camp) %>% 
  mutate(prop=n/sum(n)) %>% 
  select(-n) %>% 
  pivot_wider(names_from=laboratory_result, values_from=prop) %>% 
  select(camp, positive,negative,pending,not_done,n_a)

tests_table <- ari_ili_tests_total %>% 
  left_join(ari_ili_tests_7day, by='camp') %>% 
  left_join(ari_ili_tests_growth, by='camp') %>% 
  left_join(ari_ili_tests_result, by='camp') %>% 
  mutate(camp_number=str_extract(camp, regexp)) %>% 
  mutate(camp_number=as.numeric(camp_number)) %>% 
  arrange(camp_number) %>% 
  select(-camp_number)

gt(tests_table) %>% 
  opt_row_striping(., row_striping = TRUE) %>% 
  fmt_percent(
    columns = 4:9,
    decimals = 1
  ) %>% 
  fmt_missing(
    columns = 2:9,
    missing_text = ""
  ) %>% 
  cols_label(
    camp = "Camp",
  tests_total = "Total tests",
  tests_7day = "Tests in last 7 days",
  growth = "7-day growth(%)",
  negative = "Negative",
  not_done = "Not complete",
  pending = "Pending", 
  positive = "Positive",
  n_a = 'Result missing'
  ) %>% 
  tab_spanner(
    label = "Test results",
    columns = 5:9,
  ) %>% 
  tab_options(
    container.height = px(1000),
    container.overflow.y = TRUE
    #container.width = px(1000),
    #table.font.size = "small"
  ) 


# tests_table <- ari_ili_tests_total %>% 
#   bind_rows(ari_ili_tests_7day) %>% 
#   bind_rows(ari_ili_tests_growth) %>% 
#   pivot_longer(-camp)
# 
# tests_table %>% 
# gt() %>% 
#   opt_row_striping(., row_striping = TRUE) %>% 
#   fmt_percent(
#     columns = vars(growth),
#     decimals = 1
#   ) %>% 
#   fmt_missing(
#     columns = 2:4,
#     missing_text = ""
#   ) %>% 
#   cols_label(
#     camp = "Camp",
#   tests_total = "Total tests",
#   tests_7day = "Tests in last 7 days",
#   growth = "7-day growth(%)"
#   ) 

```


```{r test_camp_pos_gph, eval=FALSE, include=FALSE}

ggplot(tests_table, aes(x=camp, y=positive)) +
  geom_line()


```


SARI ITC & Isolation  {data-orientation=rows}
=====================================  


```{r dru_hf}

num_vars <- c('number_of_functional_sari_beds', 'number_of_currently_filled_sari_beds','number_of_expected_sari_discharges_in_next_24_hours',
              'number_of_functional_isolation_beds_non_sari','number_of_currently_filled_isolation_beds_non_sari','number_of_expected_isolation_discharges_in_next_24_hours_non_sari' )

clean_fn <- function(x){
  ifelse(x == "NULL", NA,x)
}

tableFormat <- dru_raw %>%
  clean_names() %>% 
  #mutate(facility_name=gsub(":([[:alpha:]])", ": \\1", facility_name)) %>% 
  select(timestamp,facility_name, camp, agency_in_charge, currently_accepting_patient_severity, able_to_manage_special_needs_of_covid_19_cases_tick_all_that_apply, contains('sari'), contains('isolation')) %>%
       mutate(across(num_vars, clean_fn)) %>% 
  #reformat variables to confirm they are numeric 
  mutate(across(num_vars, as.numeric)) %>% 
  #mutate(number_of_currently_filled_sari_beds=as.numeric(number_of_currently_filled_sari_beds)) %>% 
  pivot_longer(-c(timestamp,facility_name, camp, agency_in_charge, currently_accepting_patient_severity,able_to_manage_special_needs_of_covid_19_cases_tick_all_that_apply)) %>%
  mutate(camp= gsub("Camp", "", camp)) %>%
  #mutate(fac_type=ifelse(grepl('sari', name) , 'SARI', 'ISOLATION')) %>%
  mutate(fac_type=case_when(name %like% 'sari_beds|sari_discharges' ~ 'SARI',
                            name %like% 'isolation_beds|isolation_discharges' ~ 'ISOLATION')) %>%
  # mutate(fac_type=case_when(grepl('sari_beds', name) ~ 'SARI',
  #                            grepl('isolation_beds', name) ~ 'ISOLATION')) %>%
  mutate(activity=ifelse(grepl('functional', name) , 'FUNCTIONAL',
                         ifelse(grepl('filled',name), 'FILLED', 'DISCHARGES'))) %>%
  group_by(facility_name,activity) %>%
  mutate(count_beds=sum(value)) %>%
  select(timestamp,facility_name, camp, agency_in_charge, currently_accepting_patient_severity, able_to_manage_special_needs_of_covid_19_cases_tick_all_that_apply, count_beds, activity,fac_type,value) %>%
  pivot_wider(names_from=c(activity,fac_type), values_from=value) %>%
  ungroup() %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), 0, .))) %>%
  group_by(facility_name)  %>%
  summarise_all(max) %>%
  mutate(mild=ifelse(grepl('Mild', currently_accepting_patient_severity) , '+', '')) %>%
  mutate(moderate=ifelse(grepl('Moderate', currently_accepting_patient_severity) , '+', '')) %>%
  mutate(severe=ifelse(grepl('Severe', currently_accepting_patient_severity) , '+', '')) %>%
  mutate(paed=ifelse(grepl('Pead|Paed', able_to_manage_special_needs_of_covid_19_cases_tick_all_that_apply) , '+', '')) %>%
  mutate(sam=ifelse(grepl('SAM', able_to_manage_special_needs_of_covid_19_cases_tick_all_that_apply) , '+', '')) %>%
  mutate(preg=ifelse(grepl('Preg', able_to_manage_special_needs_of_covid_19_cases_tick_all_that_apply) , '+', '')) %>%
  mutate(prop_filled_sari=coalesce(FILLED_SARI/FUNCTIONAL_SARI,NA)) %>%
  mutate(prop_filled_iso=coalesce(FILLED_ISOLATION/FUNCTIONAL_ISOLATION,NA)) %>%
  select(timestamp,facility_name, camp,mild:preg, FUNCTIONAL_SARI, FILLED_SARI,prop_filled_sari, DISCHARGES_SARI,
         FUNCTIONAL_ISOLATION, FILLED_ISOLATION, prop_filled_iso,DISCHARGES_ISOLATION,count_beds)  %>%
  arrange(as.numeric(camp)) %>%
  mutate(facility_name=sub("*\\Camp*", "", facility_name)) %>%
  mutate(facility_name=gsub('[[:digit:]]+', '', facility_name)) %>%
  mutate(prop_filled_total=((FILLED_ISOLATION + FILLED_SARI)/count_beds)) %>% 
  relocate(timestamp, .after = last_col())


dru_gt_table <- tableFormat %>% 
 # left_join(last_upd, by='facility_name') %>% 
  gt() %>% 
  opt_row_striping(., row_striping = TRUE) %>% 
  tab_spanner(
    label = "Currently accepting?",
    columns = vars(mild,moderate,severe)
  ) %>% 
  tab_spanner(
    label = "Severe beds",
    columns = vars(FUNCTIONAL_SARI, FILLED_SARI,prop_filled_sari, DISCHARGES_SARI)
  ) %>% 
  tab_spanner(
    label = "Isolation beds",
    columns = vars(FUNCTIONAL_ISOLATION, FILLED_ISOLATION,prop_filled_iso, DISCHARGES_ISOLATION)
  ) %>% 
  tab_spanner(
    label = "Accepting special needs patients?",
    columns = vars(paed, sam,preg)
  ) %>% 
  tab_footnote(
    footnote = "Expected in next 24 hours",
    locations = cells_column_labels(columns = vars(DISCHARGES_SARI,DISCHARGES_ISOLATION))
  ) %>% 
  tab_footnote(
    footnote = "Severe Acute Malnutrition",
    locations = cells_column_labels(columns = vars(sam))
  ) %>% 
  tab_footnote(
    footnote = "Postpartum",
    locations = cells_column_labels(columns = vars(preg))
  ) %>% 
  tab_footnote(
    footnote = "Beds with access to 24/7 oxygen",
    locations = cells_column_spanners(spanners = "Severe beds")
  ) %>% 
  summary_rows(fns = list(Total = ~ sum(.)), columns = vars(FUNCTIONAL_SARI, FILLED_SARI, DISCHARGES_SARI,
                                                            FUNCTIONAL_ISOLATION, FILLED_ISOLATION, DISCHARGES_ISOLATION,
                                                            count_beds),
               formatter = fmt_number,
               decimals = 0,
               use_seps = TRUE) %>% 
  (function(x) {
    res <- function() x$`_data` %>% 
      dplyr::summarize(prop_filled_sari = sum(FILLED_SARI) / sum(FUNCTIONAL_SARI)) %>% 
      dplyr::pull(.data$prop_filled_sari)
    
    summary_rows(x, fns = list(Total = ~ res()), columns = vars(prop_filled_sari),
                 formatter = fmt_percent,
                 decimals = 0,
                 use_seps = TRUE)
  }) %>% 
  (function(x) {
    res <- function() x$`_data` %>% 
      dplyr::summarize(prop_filled_iso = sum(FILLED_ISOLATION) / sum(FUNCTIONAL_ISOLATION)) %>% 
      dplyr::pull(.data$prop_filled_iso)
    
    summary_rows(x, fns = list(Total = ~ res()), columns = vars(prop_filled_iso),
                 formatter = fmt_percent,
                 decimals = 0,
                 use_seps = TRUE)
  }) %>% 
  (function(x) {
    res <- function() x$`_data` %>% 
      dplyr::summarize(prop_filled_total = sum(FILLED_ISOLATION + FILLED_SARI) / sum(FUNCTIONAL_ISOLATION + FUNCTIONAL_SARI)) %>% 
      dplyr::pull(.data$prop_filled_total)
    
    summary_rows(x, fns = list(Total = ~ res()), columns = vars(prop_filled_total),
                 formatter = fmt_percent,
                 decimals = 0,
                 use_seps = TRUE)
  }) %>% 
  fmt_percent(
    columns = vars(prop_filled_sari,prop_filled_iso,prop_filled_total),
    decimals = 0
  ) %>% 
  fmt_missing(
    columns = 4:18,
    missing_text = ""
  ) %>% 
  cols_label(
    facility_name = "Facility name",
    camp = "Camp",
    mild = "Mild",
    moderate = "Moderate",
    severe = "Severe",
    paed = "Paediatric",
    sam = "SAM",
    preg = "Pregnant/PP",
    FUNCTIONAL_SARI = "Functional (n)",
    FILLED_SARI = "Filled (n)",
    prop_filled_sari = "Filled (%)",
    DISCHARGES_SARI = "Discharges (n)",
    FUNCTIONAL_ISOLATION = "Functional (n)",
    FILLED_ISOLATION = "Filled (n)",
    prop_filled_iso = "Filled (%)",
    DISCHARGES_ISOLATION = "Discharges (n)",
    count_beds = "Total beds",
    prop_filled_total = "Total filled (%)" ,
    timestamp = "Last updated"
  ) %>% 
  data_color(
    columns = vars(prop_filled_sari,prop_filled_iso,prop_filled_total),
    colors = scales::col_numeric(
      "Reds",
      domain = c(0, 1), na.color = "grey89")
  ) %>% 
  tab_source_note("Data Source: DRU Live Bed monitoring Google Sheet") %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  tab_options(
    container.overflow.x = TRUE,
    container.overflow.y = TRUE,
    grand_summary_row.background.color = "white")

 #tables[[1]]

dru_gt_table
 
```



<!---
{data-orientation=rows data-navmenu="Healthcare facility monitoring" data-icon="fa-list"}
--->

Quarantine  {data-orientation=rows}
=====================================  


```{r isolation}

quar_vars <- c('new_admissions_in_the_last_24_hours_individuals', 'current_occupancy_individuals', 
               'cumulative_contacts_individuals','cumulative_new_arrivals_travellers_individuals', 
               'number_of_rooms_shelters_currently_functional', 'number_of_rooms_shelters_currently_filled')  

quarantine_table <- quarantine_raw %>% clean_names() %>% 
    filter(!is.na(facility_name)) %>% 
  select(location_of_facility, facility_name,supporting_agency, 
         contains("individuals") ,
         number_of_rooms_shelters_currently_functional,number_of_rooms_shelters_currently_filled, timestamp) %>% 
    mutate(across(quar_vars, as.numeric)) %>% 
  mutate(prop_occupancy=number_of_rooms_shelters_currently_filled/number_of_rooms_shelters_currently_functional) %>% 
  gt() %>% 
  opt_row_striping(., row_striping = TRUE) %>% 
  tab_spanner(
    label = "Individuals",
    columns = vars(new_admissions_in_the_last_24_hours_individuals ,current_occupancy_individuals,
                   cumulative_contacts_individuals,cumulative_new_arrivals_travellers_individuals)
  ) %>% 
  tab_spanner(
    label = "Shelters",
    columns = vars(number_of_rooms_shelters_currently_functional,number_of_rooms_shelters_currently_filled,prop_occupancy)
  ) %>% 
  cols_label(
    location_of_facility = "Location",
    facility_name = "Facility name",
    supporting_agency = "Supporting agency",
    new_admissions_in_the_last_24_hours_individuals="New admissions (n)",
    current_occupancy_individuals="Current occupancy (n)",
    cumulative_contacts_individuals="Cumulative contacts (n)",
    cumulative_new_arrivals_travellers_individuals="Cumulative new arrivals (n)",
    number_of_rooms_shelters_currently_functional = "Functional (n)",
    number_of_rooms_shelters_currently_filled = "Filled (n)",
    prop_occupancy = "Filled (%)",
    timestamp="Last updated") %>% 
  summary_rows(fns = list(Total = ~ sum(.)), columns = vars(new_admissions_in_the_last_24_hours_individuals,current_occupancy_individuals,
                                                            cumulative_contacts_individuals,cumulative_new_arrivals_travellers_individuals,
                                                            number_of_rooms_shelters_currently_filled, number_of_rooms_shelters_currently_functional),
               formatter = fmt_number,
               decimals = 0,
               use_seps = TRUE) %>% 
  (function(x) {
    res <- function() x$`_data` %>% 
      dplyr::summarize(prop_occupancy = sum(number_of_rooms_shelters_currently_filled) / sum(number_of_rooms_shelters_currently_functional)) %>% 
      dplyr::pull(.data$prop_occupancy)
    
    summary_rows(x, fns = list(Total = ~ res()), columns = vars(prop_occupancy),
                 formatter = fmt_percent,
                 decimals = 0,
                 use_seps = TRUE)
  }) %>% 
  fmt_percent(
    columns = vars(prop_occupancy),
    decimals = 0
  ) %>% 
   tab_footnote(
    footnote = "In last 24 hours",
    locations = cells_column_labels(columns = vars(new_admissions_in_the_last_24_hours_individuals))
  ) %>% 
  data_color(
    columns = vars(prop_occupancy),
    colors = scales::col_numeric(
      "Reds",
      domain = c(0, 1), na.color = "grey89")
  ) %>% 
  tab_source_note("Data Source: Quarantine monitoring Google Sheet") %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  tab_options(
  container.overflow.x = TRUE,
  container.overflow.y = TRUE,
    grand_summary_row.background.color = "white")



quarantine_table

#tables[[2]]

```


