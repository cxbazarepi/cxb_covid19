---
title: 'COVID-19 Live Dashboard: Coxâ€™s Bazar, Bangladesh'
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: ''
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: bootstrap
    #logo: who_logo.png
#runtime: shiny
resource_files:
- data/camp_population.csv
- data/shapefiles/190321_Outline_RRC_Camp-A1.prj
- data/shapefiles/190321_Outline_RRC_Camp-A1.sbx
- data/shapefiles/190321_Outline_RRC_Camp-A1.sbn
- data/shapefiles/190321_Outline_RRC_Camp-A1.dbf
- data/shapefiles/190321_Outline_RRC_Camp-A1.cpg
- data/shapefiles/190321_Outline_RRC_Camp-A1.shp
- data/droptoken.rds

---
```{r global, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, error=TRUE)


library(lubridate)
library(here)
library(data.table)
library(dplyr)
#library(tibble)
#library(purrr)
library(janitor)
library(linelist)
library(forcats)
library(ggplot2)
library(ggthemes)
library(gt)
library(tidyr)
#library(RcppRoll)
#library(scales)
library(sf)
#library(leaflet)
#library(patchwork)
library(flexdashboard)
#library(linelist)
#library(googlesheets4)
#library(kableExtra)
library(plotly)
#library(httr)
#library(jsonlite)
#library(magrittr)
library(ggupset)
#library(furrr)
library(table1)
#library(deidentifyr)
library(rdrop2)
library(ggpubr)
library(tmap)
library(htmltools)


age_labs <- c(paste(seq(0, 60, by = 10), seq(9, 69, by = 10),
                    sep = "-"), paste(70, "+", sep = ""))

options(scipen=10000)


#Google data
token <- readRDS("data/droptoken.rds")
# Then pass the token to each drop_ function

#My example
drop_download(path = '/cxb/gsheet_data.Rds',
              local_path = 'gsheet_data.Rds', 
              dtoken = token, 
              overwrite = TRUE)

# Main data frame for data analysis
gsheet_data <- readRDS('gsheet_data.Rds')
#load("C:/Users/idcvdken/Dropbox (LSoHaTM)/r_cxb/dashboard/cxb_dashboard/data/gsheet_data.RData")
### All cases

all_cases_raw <- gsheet_data$host_fdmn_append %>% clean_names()

all_date_cols <- grep("(date|created_at| updated_on)", names(all_cases_raw))

all_cases_linelist <- all_cases_raw %>% clean_dates( force_Date  = all_date_cols,
                                                     guess_dates = all_date_cols) %>% 
  mutate(camp=as.numeric(camp_of_residence)) %>% 
  mutate(population_group=case_when(nationality=='FDMN' ~ 'Rohingya refugee/FDMN',
                                    nationality=='Host' ~ 'Host community')) %>% 
  filter(!(is.na(population_group))) 
  

### Testing data

tests_data <- gsheet_data$testing %>% 
  clean_names() 

### Camp population

# camp_population <- read.csv(here('data', 'camp_population.csv')) %>% 
#   mutate(camp=as.numeric(camp))

#Population 
population <- read.csv(here('data', 'population.csv')) 


### GoData
drop_download(path = '/cxb/cases.Rds',
              local_path = 'cases.Rds', 
              dtoken = token, 
              overwrite = TRUE)

cases <- readRDS('cases.Rds')

### Tables
drop_download(path = '/cxb/tables.Rds',
              local_path = 'tables.Rds', 
              dtoken = token, 
              overwrite = TRUE)

tables <- readRDS('tables.Rds')



```



Landing page
=====================================  

This dashboard provides information on COVID-19 in Cox's Bazar, Bangladesh. 


Column 
-----------------------------------------------------------------------

### Tested (24 hours & Total)

```{r test}

#Collapse tests by nationality 

test_nationality <- tests_data %>% 
    filter(!date %in% c('NULL', 'Total')) %>% 
  #mutate(host_positivity=(host_positive/host)) %>% 
  #mutate(fdmn_positivity=(fdmn_positive/fdmn)) %>% 
    mutate(date_format=excel_numeric_to_date(as.numeric(date))) %>% 
    select(-date) %>% 
    pivot_longer(-date_format) %>% 
  mutate(population_group=case_when(name=='fdmn' ~ 'Rohingya refugee/FDMN',
                                    name=='host' ~ 'Host community')) 

total_tests <- test_nationality %>% 
  filter(name %in% c('host','fdmn')) %>% 
  group_by(population_group) %>% 
  summarise(total_tests=sum(value,na.rm=TRUE),.groups = 'drop')

total_tests_fdmn <- total_tests %>% filter(population_group=='Rohingya refugee/FDMN') %>% pull(total_tests)
total_tests_host <- total_tests %>% filter(population_group=='Host community') %>% pull(total_tests)

total_tests_24h <- test_nationality %>% 
  filter(population_group %in% c('Host community','Rohingya refugee/FDMN')) %>% 
  group_by(population_group) %>% 
  filter(date_format==max(date_format)) %>% 
  summarise(total_tests=sum(value,na.rm=TRUE),.groups = 'drop')

total_tests_fdmn_24h <- total_tests_24h %>% filter(population_group=='Rohingya refugee/FDMN') %>% pull(total_tests)
total_tests_host_24h <- total_tests_24h %>% filter(population_group=='Host community') %>% pull(total_tests)

flexdashboard::valueBox(
  format(paste(total_tests_host_24h,'-', total_tests_host, '-', total_tests_fdmn, '-',total_tests_fdmn_24h), big.mark = ","),
  color = "#d6804b",
  icon = "fas fa-vials"
)

#vb_tests

```


### Dead (24 hours & Total)

```{r dead}

total_deaths <- all_cases_linelist %>% 
  filter(x30_day_outcome=='Death') %>% 
  group_by(population_group) %>% 
  summarise(n = n(),.groups = 'drop') 

total_deaths_fdmn <- total_deaths %>% filter(population_group=='Rohingya refugee/FDMN') %>% pull(n)
total_deaths_host <- total_deaths %>% filter(population_group=='Host community') %>% pull(n)

#all_deaths <- fdmn_deaths + host_deaths

total_deaths_24h <- all_cases_linelist %>% 
  filter(x30_day_outcome=='Death') %>% 
  group_by(population_group) %>% 
    filter(date_of_case_detection==max(date_of_case_detection)) %>% 
  summarise(n = n(),.groups = 'drop') 

total_deaths_fdmn_24h <- total_deaths_24h %>% filter(population_group=='Rohingya refugee/FDMN') %>% pull(n)
total_deaths_host_24h <- total_deaths_24h %>% filter(population_group=='Host community') %>% pull(n)

flexdashboard::valueBox(
  format(paste(total_deaths_host_24h,'-', total_deaths_host, '-', total_deaths_fdmn, '-',total_deaths_fdmn_24h), big.mark = ","),
  color="#D55E00"
  )

```


### Cases (24 hours & Total)

```{r case}
### Confirmed cases
total_cases <- all_cases_linelist %>% 
  group_by(population_group) %>% 
  summarise(n = n(),.groups = 'drop') 

total_cases_fdmn <- total_cases %>% filter(population_group=='Rohingya refugee/FDMN') %>% pull(n)
total_cases_host <- total_cases %>% filter(population_group=='Host community') %>% pull(n)

total_cases_24h <- all_cases_linelist %>% 
  group_by(population_group) %>% 
  filter(date_of_case_detection==max(date_of_case_detection)) %>% 
  summarise(n = n(),.groups = 'drop') 

#all_cases <- fdmn_cases + host_cases

total_cases_fdmn_24h <- total_cases_24h %>% filter(population_group=='Rohingya refugee/FDMN') %>% pull(n)
total_cases_host_24h <- total_cases_24h %>% filter(population_group=='Host community') %>% pull(n)

flexdashboard::valueBox(
  format(paste(total_cases_host_24h,'-', total_cases_host, '-', total_cases_fdmn_24h, '-',total_cases_fdmn), big.mark = ","),
  icon = "fas fa-user-md",
  color= "light blue"
)


```

column {data-width=400}
-------------------------------------

### Links to documents

```{r}

```


### Partners

```{r partners, echo=FALSE, fig.cap="A caption", out.width = '50%'}

knitr::include_graphics(c("bgd_logo.png","who_bgd_logo.png"))


```



Column {data-width=600}
-------------------------------------

### COVID-19 cases in Bangladesh

```{r}

bgd_data <- fread('https://covid.ourworldindata.org/data/owid-covid-data.csv') %>% 
  filter(iso_code=='BGD') %>%        
  mutate(date_format=ymd(date))  %>% 
  mutate(case_growth=ifelse(lag(total_cases,7)>10,
                            ((total_cases/lag(total_cases,7))^(1/7))-1,NA),
         case_doubling=ifelse(case_growth>0,log(2)/case_growth,NA),
         case_doubling=ifelse(case_doubling>100,100,case_doubling)) %>% 
  select(date=date_format, name=iso_code, case_growth, case_doubling, total_cases)


  cxb_data <- tests_data %>%  
    select(date, fdmn_positive, host_positive) %>% 
    filter(!date %in% c('NULL', 'Total')) %>% 
    pivot_longer(-date) %>% 
    mutate(date_format=excel_numeric_to_date(as.numeric(date)))  %>% 
    arrange(date_format,name) %>% 
    group_by(name) %>% 
    mutate(total_cases=cumsum(value)) %>% 
    mutate(case_growth=ifelse(lag(total_cases,7)>10,
                              ((total_cases/lag(total_cases,7))^(1/7))-1,NA),
           case_doubling=ifelse(case_growth>0,log(2)/case_growth,NA),
           case_doubling=ifelse(case_doubling>100,100,case_doubling))  %>% 
    arrange(name, date_format) %>% 
    select(date=date_format, name, case_growth, case_doubling, total_cases)
  
  bgd_cxb_data_gph <- bgd_data %>% 
  bind_rows(cxb_data) %>% 
  ggplot(., aes(x=date, y=total_cases, color=name)) +
  geom_line() +
  labs(caption="Data source:Our World In Data (Bangladesh data), Lab linelist",
           x = "Date",
           y = "Total cases",
           fill="") +
      theme_tufte() +
      theme(legend.position="top") +
      scale_x_date(date_breaks = '7 day', date_minor_breaks = '1 day',
                   date_labels = '%d-%m') +
     scale_y_continuous(trans = 'log10') 

  
# bgd_cxb_data_gph <- bgd_data %>% 
#   bind_rows(cxb_data) %>% 
#   ggplot(., aes(x=date, y=case_doubling, color=name)) +
#   geom_line() +
#   labs(caption="Data source:Our World In Data (Bangladesh data), Lab linelist",
#            x = "Date",
#            y = "Case doubling time (days)",
#            fill="") +
#       theme_tufte() +
#       theme(legend.position="top") +
#       scale_x_date(date_breaks = '7 day', date_minor_breaks = '1 day',
#                    date_labels = '%d-%m')

ggplotly(bgd_cxb_data_gph)


```




```{r data_formatting}

#Total cases by camp
cases_total <- all_cases_linelist %>% 
  #filter(nationality!='Nationality') %>% 
  mutate(upazilla=case_when(upazilla=='CXB Sadar' ~ 'Sadar', 
                            TRUE~upazilla)) %>% 
  count(population_group, upazilla, camp) %>% 
  rename(confirmed=n) 


fdmn_total <- cases_total %>% 
  filter(population_group=='Rohingya refugee/FDMN')

week_start <- today()-7

#Cases in last days by camp
cases_7days <- all_cases_linelist %>%
  count(population_group, upazilla, camp,date_of_case_detection) %>% 
  filter(date_of_case_detection>=week_start) %>% 
  group_by(population_group, upazilla, camp) %>% 
  slice(tail(row_number(), 7)) %>% 
  mutate(sevenday_sum=sum(n)) %>% 
  slice(tail(row_number(), 1)) %>% 
  select(population_group, upazilla, camp,sevenday_sum)

#Total in isolation
isolation_total <- all_cases_linelist %>% 
  filter(grepl('isolation', last_status_of_patient)) %>% 
  count(population_group, upazilla, camp) %>% 
  rename(isolation=n)

#Total recovered
recovered_total <- all_cases_linelist %>% 
  filter(grepl('^Reco', x30_day_outcome)) %>% 
  count(population_group, upazilla, camp) %>% 
  rename(recovered=n)

#Total deceased
dead_total <-  all_cases_linelist %>%  
  filter(grepl('Dea', x30_day_outcome)) %>% 
  count(population_group, upazilla, camp) %>% 
  rename(dead=n)

#Camp population 
# camp_population <- population %>% 
#   filter(population_group=='fdmn') %>% 
#   mutate(camp=as.numeric(str_extract_all(location, "[0-9]+")[[1]]))


#library(stringr)


#Formatted data table
summaryTable_df <- cases_total %>% 
  left_join(., cases_7days, by=c('population_group', 'upazilla', 'camp')) %>%
  left_join(., recovered_total, by=c('population_group', 'upazilla', 'camp')) %>%
  left_join(., dead_total, by=c('population_group', 'upazilla', 'camp'))  %>% 
  mutate(location=coalesce(as.character(camp),upazilla)) %>% 
  left_join(., population, by='location') %>% 
  mutate(prop_recovered=recovered/confirmed) %>% 
  mutate(prop_dead=dead/confirmed) %>% 
  mutate(attack_rate=confirmed/population*10000) %>% 
  mutate(attack_rate=round(attack_rate,2)) %>% 
  select(-c(population,location)) %>% 
  arrange(camp)


```




Host community  {data-orientation=columns}
=====================================  

Row 
-------------------------------------
   
### Table {data-height=650}


```{r}
summaryTable_host <- 
  summaryTable_df %>%  
  filter(population_group=='Host community') %>% 
  select(-c("recovered","prop_recovered","population_group","camp")) %>% 
  gt() %>% 
  opt_row_striping(., row_striping = TRUE) %>% 
  tab_spanner(
    label = "Cases",
    columns = vars(confirmed, sevenday_sum, attack_rate)
  ) %>% 
  tab_spanner(
    label = "Dead",
    columns = vars(dead, prop_dead)
  ) %>% 
  fmt_percent(
    columns = vars(prop_dead),
    decimals = 1
  ) %>% 
  fmt_missing(
    columns = 2:5,
    missing_text = ""
  ) %>% 
  cols_label(
    #population_group = "Population group",
    upazilla = "Upazilla",
    #camp = "Camp",
    confirmed = "Total",
    sevenday_sum = "Last 7 days",
  attack_rate = "Attack Rate",
    #recovered = "(n)",
    dead = "(n)",
    #prop_recovered = "(%)",
    prop_dead = "CFR"
  ) %>% 
grand_summary_rows(
  columns = c("confirmed","sevenday_sum","dead"),
  fns = list(
    "Total" = ~sum(.,na.rm = TRUE)),
  formatter = fmt_number,
  decimals=0,
  use_seps = FALSE
)  %>% 
  (function(x) {
    res <- function() x$`_data` %>% 
      dplyr::summarize(prop_dead = sum(dead, na.rm=TRUE) / sum(confirmed, na.rm=TRUE)) %>% 
      dplyr::pull(.data$prop_dead)
    
    grand_summary_rows(x, fns = list(Total = ~ res()), columns = vars(prop_dead),
                       formatter = fmt_percent,
                       decimals = 1,
                       use_seps = TRUE)
  }) %>% 
  tab_source_note("Data Source: FDMN/Host Linelist") %>% 
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>% 
  cols_align(
    align = "center",
    columns = gt::everything()
  ) %>% 
  tab_options(
    container.overflow.x = TRUE,
    container.overflow.y = TRUE,
    grand_summary_row.background.color = "lightblue")

summaryTable_host
```   

### Testing {data-height=350}

```{r daily_tests}

testing_host_gph <-  test_nationality %>% 
      filter(name %in% c('host', 'host_positive')) %>% 
      ggplot(., aes(x=date_format, y=value, fill=name)) +
               geom_bar(stat="identity",position ="identity") +
      scale_fill_manual(values=c("#ED7D31","#4472C4"), labels=c('tests','cases')) +
      labs(caption="Data source: Lab data",
           x = "Date",
           y = "Number of tests",
           fill="") +
      theme_tufte() +
      theme(legend.position="top") +
      scale_x_date(date_breaks = '7 day', date_minor_breaks = '1 day',
                   date_labels = '%d-%m')

ggplotly(testing_host_gph)


```



Column 
-------------------------------------


### Map


```{r host_map}

# shp_file_host<- read_sf(list.files(here('data','shapefiles'), 
#                                pattern='districe.shp$', 
#                                full.names = T))  %>% 
#   clean_names() %>% 
#   mutate(upazilla=case_when(grepl('sadar', adm3_en, ignore.case=TRUE) ~ 'Sadar',
#                             grepl('Maheshkhali', adm3_en, ignore.case=TRUE) ~ 'Moheshkhali',
#                             grepl('Chakaria', adm3_en, ignore.case=TRUE) ~ 'Chokoria',
#                            TRUE ~ adm3_en))

# case_shp_host <- summaryTable_df %>% 
#   filter(population_group=='Host community') %>% 
#   #mutate(code=(camp)) %>% 
#   select(upazilla,confirmed) %>% 
#   #filter(!is.na(upazilla)) %>% 
#   left_join(shp_file_host,.,by=c('upazilla'='upazilla'))
# 
# 
# 
# pal_host <- colorNumeric(
#   palette = "YlOrRd",
#   domain = case_shp_host$confirmed)
# 
# labels_host<- sprintf(
#   "<strong>%s</strong><br/>%g cases",
#   case_shp_host$adm3_en, case_shp_host$confirmed) %>% 
#   lapply(htmltools::HTML)
# 
# 
# 
# map_fdmn <- leaflet(case_shp_host) %>% 
#   #addBingTiles(apikey = "AnaeBcYpazAbocaXxVvcxxKJZj9w9nRH0UGTuix0FZ8HQjE6R-31VwpZlGAD6Fei") %>%
#   addProviderTiles("OpenStreetMap") %>% 
#   addPolygons(fillColor = ~pal_host(confirmed),
#               weight = 2,
#               opacity = 1,
#               color = "white",
#               dashArray = "3",
#               fillOpacity = 0.7,
#               label = labels_host,
#               labelOptions = labelOptions(
#                 style = list("font-weight" = "normal", padding = "3px 8px"),
#                 textsize = "15px",
#                 direction = "auto")) %>%
#   addLegend(pal = pal_host, 
#             values = ~confirmed, opacity = 0.7,
#             position = "bottomright", title="Confirmed cases (n)")
# map_fdmn



shp_file_host <- read_sf(here('data', 'shapefiles', 'cxb_shp.shp'))

case_shp_host <- summaryTable_df %>% 
  filter(population_group=='Host community') %>% 
  #mutate(code=(camp)) %>% 
  select(upazilla,confirmed) %>% 
  #filter(!is.na(upazilla)) %>% 
  left_join(shp_file_host,.,by=c('upazilla'='upazilla'))



# pal_host <- colorNumeric(
#   palette = "YlOrRd",
#   domain = case_shp_host$confirmed)
# 
# labels_host<- sprintf(
#   "<strong>%s</strong><br/>%g cases",
#   case_shp_host$upazilla, case_shp_host$confirmed) %>%
#   lapply(htmltools::HTML)
# 
# 
# 
# leaflet(case_shp_host) %>%
#   addProviderTiles("OpenStreetMap") %>%
#   addPolygons(fillColor = ~pal_host(confirmed),
#               weight = 2,
#               opacity = 1,
#               color = "white",
#               dashArray = "3",
#               fillOpacity = 0.7,
#               label = labels_host,
#               labelOptions = labelOptions(
#                 style = list("font-weight" = "normal", padding = "3px 8px"),
#                 textsize = "15px",
#                 direction = "auto")) %>%
#   addLegend(pal = pal_host,
#             values = ~confirmed, opacity = 0.7,
#             position = "bottomright", title="Confirmed cases (n)")
#
# 
# ggplot(data = case_shp_host) +
#   geom_sf(aes(fill = confirmed)) +
#   scale_fill_viridis_c() 

#tmap_mode("plot")

# tm_shape(case_shp_host) + 
#   tm_polygons("confirmed", title="Confirmed COVID-19 cases", palette='YlOrRd') +   
#   tm_text("upazilla", root=5) +
#   tm_legend(text.size=1,
#             title.size=1.2,
#             position = c("left","bottom"), 
#             bg.color = "white", 
#             bg.alpha=.2, 
#             width=.8,
#             frame="white", 
#             height=.6)

map_host  <- tm_shape(case_shp_host) + 
  tm_polygons("confirmed", title="Confirmed COVID-19 cases", palette='YlOrRd') +   
  tm_text("upazilla", root=5, size = 1/2) +
  tm_legend(text.size=1,
            title.size=1.2,
            position = c("left","bottom"), 
            bg.color = "white", 
            bg.alpha=.2, 
            width=.8,
            frame="white", 
            height=.6)

tmap_leaflet(map_host)

```


 
 
FDMN/Rohynga community {data-orientation=columns}
=====================================  

Row 
-------------------------------------
   
### Table {data-height=650}
    
```{r}

summaryTable_fdmn <- summaryTable_df %>%  
      filter(population_group=='Rohingya refugee/FDMN') %>% 
      mutate(camp=factor(camp)) %>% 
      mutate(camp=fct_explicit_na(camp, na_level = "(missing)"))  %>% 
      group_by(camp) %>% 
      summarise(confirmed=sum(confirmed, na.rm=TRUE),
                sevenday_sum=sum(sevenday_sum, na.rm=TRUE),
                dead=sum(dead, na.rm=TRUE),
                attack_rate=sum(attack_rate, na.rm=TRUE)) %>% 
  #select(-upazilla) %>% 
    #select(-c("recovered","prop_recovered","population_group","")) %>% 
  mutate(prop_dead=dead/confirmed) %>% 
    #filter(nationality==input$nationality1) %>% 
    #gt() %>% 
  gt(
   # groupname_col = "population_group"
  ) %>% 
    opt_row_striping(., row_striping = TRUE) %>% 
    tab_spanner(
      label = "Cases",
      columns = vars(confirmed, sevenday_sum,attack_rate)
    ) %>% 
    # tab_spanner(
    #   label = "Recovered",
    #   columns = vars(recovered, prop_recovered)
    # ) %>% 
    tab_spanner(
      label = "Dead",
      columns = vars(dead, prop_dead)
    ) %>% 
    fmt_percent(
      columns = vars(prop_dead),
      decimals = 1
    ) %>% 
    fmt_missing(
      columns = 2:5,
      missing_text = ""
    ) %>% 
    cols_label(
      #population_group = "Population group",
      #upazilla = "Upazilla",
      camp = "Camp",
      confirmed = "Total",
      sevenday_sum = "Last 7 days",
      attack_rate = "Attack Rate",
      #recovered = "(n)",
      dead = "(n)",
      #prop_recovered = "(%)",
      prop_dead = "CFR"
    ) %>% 
    grand_summary_rows(
      columns = c("confirmed","sevenday_sum","dead"),
      fns = list(
        "Total" = ~sum(.,na.rm = TRUE)),
      formatter = fmt_number,
      decimals=0,
      use_seps = FALSE
    )  %>% 
    (function(x) {
      res <- function() x$`_data` %>% 
        dplyr::summarize(prop_dead = sum(dead, na.rm=TRUE) / sum(confirmed, na.rm=TRUE)) %>% 
        dplyr::pull(.data$prop_dead)
      
      grand_summary_rows(x, fns = list(Total = ~ res()), columns = vars(prop_dead),
                   formatter = fmt_percent,
                   decimals = 1,
                   use_seps = TRUE)
    }) %>% 
    tab_source_note("Data Source: FDMN/Host Linelist") %>% 
    tab_style(
      style = list(
        cell_borders(
          sides = "bottom",
          color = "black",
          weight = px(3)
        )
      ),
      locations = list(
        cells_column_labels(
          columns = gt::everything()
        )
      )
    ) %>% 
    cols_align(
      align = "center",
      columns = gt::everything()
    ) %>% 
  tab_options(
    container.overflow.x = TRUE,
    container.overflow.y = TRUE,
    grand_summary_row.background.color = "lightblue")

summaryTable_fdmn
```


### Testing {data-height=350}

```{r}
testing_fdmn_gph <-  test_nationality %>% 
      filter(name %in% c('fdmn', 'fdmn_positive')) %>% 
      ggplot(., aes(x=date_format, y=value, fill=name)) +
               geom_bar(stat="identity",position ="identity") +
      scale_fill_manual(values=c("#ED7D31","#4472C4"), labels=c('tests','cases')) +
      labs(caption="Data source: Lab data",
           x = "Date",
           y = "Number of tests",
           fill="") +
      theme_tufte() +
      theme(legend.position="top") +
      scale_x_date(date_breaks = '7 day', date_minor_breaks = '1 day',
                   date_labels = '%d-%m')

ggplotly(testing_fdmn_gph)
```



Column 
-------------------------------------

### Map

```{r fdmn_map}

shp_file_fdmn <- read_sf(list.files(here('data','shapefiles'), 
                               pattern='1.shp$', 
                               full.names = T)) %>% 

  clean_names() %>% 
  mutate(code=as.numeric(code))

case_shp_fdmn <- summaryTable_df %>% 
  filter(population_group=='Rohingya refugee/FDMN') %>% 
  mutate(code=(camp)) %>% 
  select(code,confirmed) %>% 
  filter(!is.na(code)) %>% 
  left_join(shp_file_fdmn,.,by='code')


# pal_fdmn <- colorNumeric(
#   palette = "YlOrRd",
#   domain = case_shp_fdmn$confirmed)
# 
# labels_fdmn <- sprintf(
#   "<strong>%s</strong><br/>%g cases",
#   case_shp_fdmn$new_camp_n, case_shp_fdmn$confirmed
# ) %>% lapply(htmltools::HTML)
# 
# 
# 
# map_fdmn <- leaflet(case_shp_fdmn) %>% 
#   #addBingTiles(apikey = "AnaeBcYpazAbocaXxVvcxxKJZj9w9nRH0UGTuix0FZ8HQjE6R-31VwpZlGAD6Fei") %>%
#   addProviderTiles("OpenStreetMap") %>% 
#   addPolygons(fillColor = ~pal_fdmn(confirmed),
#               weight = 2,
#               opacity = 1,
#               color = "white",
#               dashArray = "3",
#               fillOpacity = 0.7,
#               label = labels_fdmn,
#               labelOptions = labelOptions(
#                 style = list("font-weight" = "normal", padding = "3px 8px"),
#                 textsize = "15px",
#                 direction = "auto")) %>% 
#   addLegend(pal = pal_fdmn, 
#             values = ~confirmed, opacity = 0.7,
#             position = "bottomright", title="Confirmed cases (n)")

# case_shp_fdmn %>% 
#   mutate(camp=gsub('Camp', '', new_camp_n)) %>% 
# tm_shape(.) + 
#   tm_polygons("confirmed", title="Confirmed COVID-19 cases", palette='YlOrRd') +   
#   tm_text("camp", root=5, text.size = 0.6) +
#   tm_legend(text.size=1,
#             title.size=1.2,
#             position = c("left","bottom"), 
#             bg.color = "white", 
#             bg.alpha=.2, 
#             width=.8,
#             frame="white", 
#             height=.6) +
#   tm_facets("upazila") 

#map_fdmn

map_fdmn <- case_shp_fdmn %>% 
  mutate(camp=gsub('Camp', '', new_camp_n)) %>% 
  tm_shape(.) + 
  tm_polygons("confirmed", title="Confirmed COVID-19 cases", palette='YlOrRd') +   
  tm_text("camp", root=5, size = 1/2) +
  tm_legend(text.size=1,
            title.size=1.2,
            position = c("left","bottom"), 
            bg.color = "white", 
            bg.alpha=.2, 
            width=.8,
            frame="white", 
            height=.6) +
  tm_facets("upazila", ncol=1)
tmap_leaflet(map_fdmn)

```




Epidemiology {data-orientation=columns}
=====================================  

This tab shows information from GoData. The data are only from the FDMN/Rohynga population. 



```{r epi_wranging}

godata_wide <- cases %>%
  clean_names() %>% 
  filter(deleted == FALSE) %>%
  unnest(c(
    #addresses,
    date_ranges,
    #questionnaire_answers_nationality,
    #questionnaire_answers_nationality_2,
    #questionnaire_answers_cif_nationality,
    contains('nationality'),
    contains('result'),
    contains('symptom'),
    # questionnaireAnswers.numeroIDcasIndex,
    # questionnaireanswers_liendeparente
  ),
  keep_empty = TRUE, names_sep = "_")


godata_clean <- godata_wide %>% 
  #Ethnicity
  mutate(population_group=coalesce(questionnaire_answers_nationality_value,questionnaire_answers_nationality_2_value,questionnaire_answers_cif_nationality_value)) %>% 
  filter(population_group=='FDMN')  %>% 
  #Test result
  mutate(lab_result=coalesce(questionnaire_answers_lab_result_value,questionnaire_answers_result_2_value)) %>% 
  filter(lab_result=='Positive') %>% 
  #Dates
  mutate(date_of_reporting = guess_dates(date_of_reporting),
         #date_of_data_entry = guess_dates(createdat),
         date_of_onset = guess_dates(date_of_onset),
         date_of_outcome = guess_dates(date_of_outcome),
         date_of_last_contact = guess_dates(date_of_last_contact),
         date_become_case = guess_dates(date_become_case)) %>% 
  #Age
  mutate(age_years = case_when(
    is.na(age_years) && !is.na(age_months) ~  as.integer(age_months / 12),
    is.na(age_years) && is.na(age_months) ~  NA_integer_,
    TRUE ~ age_years)) %>%
  #Age group
  mutate(age_group=cut(age_years,breaks = c(seq(0, 70, by = 10), Inf), labels = age_labs, right = FALSE)) %>%
  mutate(age_group=fct_explicit_na(age_group, na_level = "(missing)")) %>% 
  #Classification
  filter(classification != "lng_reference_data_category_case_classification_not_a_case_discarded") %>%
  mutate(classification = case_when(
        grepl('confirmed', classification, ignore.case=TRUE) ~ "confirmed",
            grepl('suspect', classification, ignore.case=TRUE) ~ "suspect",
            grepl('probable', classification, ignore.case=TRUE) ~ "probable"
  )) %>%
  #Sex
  mutate(sex = case_when(
                grepl('_male', gender, ignore.case=TRUE) ~ "male",
        grepl('_female', gender, ignore.case=TRUE) ~ "female"
  )) %>%
  #Updated this classification to match survey
  #updated to "outcome"
  mutate(outcome = case_when(
            grepl('alive', outcome_id, ignore.case=TRUE) ~ "alive",
            grepl('deceased', outcome_id, ignore.case=TRUE) ~ "dead",
            grepl('recovered', outcome_id, ignore.case=TRUE) ~ "recovered",
            grepl('death', questionnaire_answers_outcome, ignore.case=TRUE) ~ "dead"
  )) %>%
  #Risk level
  mutate(risk_level = case_when(
            grepl('low', risk_level, ignore.case=TRUE) ~ "low",
            grepl('medium', risk_level, ignore.case=TRUE) ~ "medium",
            grepl('high', risk_level, ignore.case=TRUE) ~ "high"
  )) %>%
  #Updated available options
  mutate(status = case_when(
                grepl('hospitalization', date_ranges_typeId, ignore.case=TRUE) ~ "hospitalization",
                grepl('other', date_ranges_typeId, ignore.case=TRUE) ~ "other",
                grepl('isolation', date_ranges_typeId, ignore.case=TRUE) ~ "isolation"
  )) %>%
  mutate(pregnant = case_when(grepl('trimester', date_ranges_typeId, ignore.case=TRUE) ~ "pregnant"
  )) %>%
  mutate(pregnant=case_when(grepl('yes',questionnaire_answers_pregnant,ignore.case=TRUE)~1)) %>% 
  #Symptoms
  #Cough
  mutate(cough=case_when(grepl('cough',questionnaire_answers_respiratory_symptoms_value,ignore.case=TRUE)~1,
                         grepl('yes', questionnaire_answers_cough,ignore.case=TRUE)~1)) %>% 
  #Rapid breathing 
  mutate(rapid_breathing=case_when(grepl('rapid breathing',questionnaire_answers_respiratory_symptoms_value,ignore.case=TRUE)~1,
                         grepl('yes', questionnaire_answers_rapid_breathing,ignore.case=TRUE)~1)) %>%
  #Respiratory distress
  mutate(resp_distress=case_when(grepl('severe respiratory distress',questionnaire_answers_respiratory_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_acute_respiratory_distress_syndrome_ards,ignore.case=TRUE)~1)) %>% 
  #Runny nose
  mutate(runny_nose=case_when(grepl('Runny nose',questionnaire_answers_respiratory_symptoms_value,ignore.case=TRUE)~1,
                                 grepl('yes', questionnaire_answers_runny_nose,ignore.case=TRUE)~1)) %>% 
  #Fever
  mutate(fever=case_when(grepl('Fever',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_fever,ignore.case=TRUE)~1)) %>% 
  #Loss of smell 
  mutate(loss_smell=case_when(grepl('Loss of smell',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_loss_of_smell,ignore.case=TRUE)~1)) %>% 
  #Fatigue
  mutate(fatigue=case_when(grepl('Fatigue',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_fatigue,ignore.case=TRUE)~1)) %>% 
    #Loss of appetite
  mutate(loss_appetite=case_when(grepl('Loss of appetite',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_loss_of_appetite,ignore.case=TRUE)~1)) %>% 
     #Sore throat
  mutate(sore_throat=case_when(grepl('Sore throat',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_sore_throat,ignore.case=TRUE)~1)) %>% 
  #Diarrhoea
    mutate(sore_throat=case_when(grepl('Diarrhoea',questionnaire_answers_symptoms_value,ignore.case=TRUE)~1,
                                   grepl('yes', questionnaire_answers_diarrhoea,ignore.case=TRUE)~1)) %>% 
  #Pre-existing conditions
  #Hypertension
  mutate(htn=case_when(grepl('hypertension',questionnaire_answers_select_pre_existing_medical_condition,ignore.case=TRUE)~1,
                         grepl('yes', questionnaire_answers_hypertension,ignore.case=TRUE)~1)) 


```



```{r cases}

case_age_sex <- godata_clean %>% 
  count(sex,age_group)

max_case <- max(case_age_sex$n)

case_age_sex_gph <- ggplot(case_age_sex,
       aes(x = age_group,
           y = ifelse(sex == 'male', n, -n),
           fill = sex)) +
  geom_bar(stat = "identity", width = 0.7) +
  coord_flip() +
  scale_y_continuous(limits = c(-max_case, max_case),
                     breaks = seq(-max_case, max_case, 2),
                     labels = abs(seq(-max_case, max_case, 2))) +
  labs(x = "Age", y = "Number of cases", fill = '') +
  theme_minimal()


```


```{r deaths}

death_age_sex <- godata_clean %>% 
  filter(outcome=='dead') %>% 
  count(sex,age_group, .drop = FALSE)

max_deaths <- max(death_age_sex$n)

death_age_sex_gph <- ggplot(death_age_sex,
       aes(x = age_group,
           y = ifelse(sex == 'male', n, -n),
           fill = sex)) +
  geom_bar(stat = "identity", width = 0.7) +
  coord_flip() +
  scale_y_continuous(limits = c(-max_case, max_case),
                     breaks = seq(-max_case, max_case, 2),
                     labels = abs(seq(-max_case, max_case, 2))) +
  labs(x = "Age", y = "Number of deaths", fill = '') +
  theme_minimal()
```


Row 
-------------------------------------


### Age and sex distribution


```{r}
ggarrange(case_age_sex_gph, death_age_sex_gph, ncol=2, common.legend = TRUE, legend="top")
```



### TBC {data-height=350}


Column 
-------------------------------------

### Descriptive table

```{r}
label(godata_clean$age_years) <- "Age"
label(godata_clean$sex) <- "Sex"
label(godata_clean$outcome) <- "Outcome"
label(godata_clean$questionnaire_answers_travel_outside_camps) <- "Travel outside camp (last 14 days)"
 label(godata_clean$status) <- "Status"
 label(godata_clean$risk_level) <- "Risk level"

table1(~ age_years + sex + outcome + risk_level , data=godata_clean, topclass="Rtable1-zebra",footnote="Data source: GoData") 
```


### Symptom profile

```{r symptoms}

godata_clean %>% 
    #filter(population_group=='Rohingya refugee/FDMN') %>% 
    #filter(test_result=='Positive') %>% 
    select(id, cough, rapid_breathing, resp_distress, runny_nose, fever) %>% 
    pivot_longer(-id) %>% 
    filter(value==1) %>% 
    arrange(id, name) %>% 
    select(-value) %>% 
    group_by(id) %>%
    summarize(symptom_list = list(name)) %>% 
    ggplot(aes(x=symptom_list)) +
    geom_bar() +
    theme_bw() +
    labs(x = "",
         y = "Number of cases",
         title="Distribution of symptoms at presentation",
         caption="Data source: GoData") +
    scale_x_upset(n_intersections = 20)


```


SARI ITC  {data-orientation=rows data-navmenu="Facility monitoring" data-icon="fa-list"}
=====================================  


```{r dru_hf}

 tables[[1]]
 
```


Isolation  {data-orientation=rows data-navmenu="Facility monitoring" data-icon="fa-list"}
=====================================  


```{r isolation}

# quarantine_table_df <- gsheet_data$quarantine %>%
#   clean_names() %>% 
#   #left_join(test, by='facility_name') %>%
#   filter(!is.na(facility_name)) %>%
#   select(location_of_facility, facility_name,supporting_agency,
#          contains("individuals") ,
#          number_of_rooms_shelters_currently_functional,number_of_rooms_shelters_currently_filled, timestamp) %>%
#   mutate(prop_occupancy=number_of_rooms_shelters_currently_filled/number_of_rooms_shelters_currently_functional)
# 
#   quarantine_table <- quarantine_table_df %>%
#     gt() %>%
#   opt_row_striping(., row_striping = TRUE) %>%
#   tab_spanner(
#     label = "Individuals",
#     columns = vars(new_admissions_in_the_last_24_hours_individuals ,current_occupancy_individuals,
#                    cumulative_contacts_individuals,cumulative_new_arrivals_travellers_individuals)
#   ) %>%
#   tab_spanner(
#     label = "Shelters",
#     columns = vars(number_of_rooms_shelters_currently_functional,number_of_rooms_shelters_currently_filled,prop_occupancy)
#   ) %>%
#   cols_label(
#     location_of_facility = "Location",
#     facility_name = "Facility name",
#     supporting_agency = "Supporting agency",
#     new_admissions_in_the_last_24_hours_individuals="New admissions (n)",
#     current_occupancy_individuals="Current occupancy (n)",
#     cumulative_contacts_individuals="Cumulative contacts (n)",
#     cumulative_new_arrivals_travellers_individuals="Cumulative new arrivals (n)",
#     number_of_rooms_shelters_currently_functional = "Functional (n)",
#     number_of_rooms_shelters_currently_filled = "Filled (n)",
#     prop_occupancy = "Filled (%)",
#     timestamp="Last updated") %>%
#   summary_rows(fns = list(Total = ~ sum(.)), columns = vars(new_admissions_in_the_last_24_hours_individuals,current_occupancy_individuals,
#                                                             cumulative_contacts_individuals,cumulative_new_arrivals_travellers_individuals,
#                                                             number_of_rooms_shelters_currently_filled, number_of_rooms_shelters_currently_functional),
#                formatter = fmt_number,
#                decimals = 0,
#                use_seps = TRUE) %>%
#   (function(x) {
#     res <- function() x$`_data` %>%
#       dplyr::summarize(prop_occupancy = sum(number_of_rooms_shelters_currently_filled) / sum(number_of_rooms_shelters_currently_functional)) %>%
#       dplyr::pull(.data$prop_occupancy)
# 
#     summary_rows(x, fns = list(Total = ~ res()), columns = vars(prop_occupancy),
#                  formatter = fmt_percent,
#                  decimals = 1,
#                  use_seps = TRUE)
#   }) %>%
#   fmt_percent(
#     columns = vars(prop_occupancy),
#     decimals = 1
#   ) %>%
#   tab_footnote(
#     footnote = "In last 24 hours",
#     locations = cells_column_labels(columns = vars(new_admissions_in_the_last_24_hours_individuals))
#   ) %>%
#   data_color(
#     columns = vars(prop_occupancy),
#     colors = scales::col_numeric(
#       "Reds",
#       domain = c(0, 1), na.color = "light grey")
#   ) %>%
#   tab_source_note("Data Source: Quarantine monitoring Google Sheet") %>%
#   tab_style(
#     style = list(
#       cell_borders(
#         sides = "bottom",
#         color = "black",
#         weight = px(3)
#       )
#     ),
#     locations = list(
#       cells_column_labels(
#         columns = gt::everything()
#       )
#     )
#   ) %>%
#   cols_align(
#     align = "center",
#     columns = gt::everything()
#   ) %>%
#   tab_options(
#     container.overflow.x = TRUE,
#     container.overflow.y = TRUE,
#     grand_summary_row.background.color = "lightblue")

#quarantine_table

tables[[2]]

```


